<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Malloy Documentation</title>
    <link rel="stylesheet" href="/malloy/css/document.css">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"/>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <img src="/malloy/img/logo.png" alt="malloy logo"/>Malloy <span class="subtitle">Documentation</span>
      </div>
      <div class="main">
        <div class="sidebar">
    <div>
        <div class="sidebar-section-title">Getting Started</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/index.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Tao of Malloy
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/features.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Key Features
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Language Reference</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/language/overview.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Introduction
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/basic.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Malloy Quickstart
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/statement.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Models
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/explore.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Explores
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/query.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Queries
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/fields.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Fields
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/types.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Types
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/expressions.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Expressions
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/order_by.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Ordering and Limiting
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/join.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Joins
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/filters.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Filters
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/nesting.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Nested Queries
            </a>
          </div>
<div class='sidebar-item active'>
            <a href="/malloy/documentation/language/aggregates.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Aggregates
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/imports.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Imports and Exports
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Common Patterns</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/yoy.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Year Over Year Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/foreign_sums.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Foreign Sums and Averages
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/percent_of_total.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Percent of Total
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/cohorts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Cohort Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/pivot_limits.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Pivot Limits
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/sessionize.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Sessionized Data
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Visualizations</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/bar_charts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Bar Charts
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/charts_line_chart.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Line Charts
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/shape_maps.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Shape Maps
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/segment_maps.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Segment Maps
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/scatter_charts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Scatter Charts
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Examples</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/examples/ecommerce.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              eCommerce Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/faa.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              NTSB Flight Database
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/names.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Name Game
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/ga_sessions.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Google Analytics GA360
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Iowa Liquor - An Analysis</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/iowa.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              About the Data Set
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/source.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Malloy Data Model
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step2.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Basic Calculations
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step2a.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Analysis: Products and Brands
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step3.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Bucketing and Mapping
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step6.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Dashboards
            </a>
          </div>
      </div>

  </div>
        <div class="content">
          <div class="footer">
            
            <div class="linear-navigation">
    <div class="item">
      <a href="nesting.html"><img src="/malloy/img/previous.svg" alt="previous"/>Nested Queries</a>
    </div>
    <div class="item">
      <a href="imports.html">Imports and Exports<img src="/malloy/img/next.svg" alt="next"/></a>
    </div>
  </div>
            
          </div>
          <div class="document-outer">
            <div class="document">
      <h1>
        <a id="aggregates" class="header-link anchor" href="#aggregates">
          Aggregates
        </a>
      </h1>
    <p>Malloy supports the standard aggregate functions <code class="language-malloy">count</code>, <code class="language-malloy">sum</code>, <code class="language-malloy">avg</code>, <code class="language-malloy">min</code>, and <code class="language-malloy">max</code>. When these are used in a field's definition, they make that field a <a href="fields.html#measures">measure</a>.</p>

      <h2>
        <a id="basic-syntax" class="header-link anchor" href="#basic-syntax">
          Basic Syntax
        </a>
      </h2>
    
      <h3>
        <a id="counts" class="header-link anchor" href="#counts">
          Counts
        </a>
      </h3>
    <p>The <code class="language-malloy">count</code> aggregate function may be used to count the number of records appearing in an explore.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> flights <span class="token operator">|</span> <span class="token keyword">reduce</span> flight_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore flights | reduce flight_count is count()
  | ^</div>
      <h3>
        <a id="distinct-counts" class="header-link anchor" href="#distinct-counts">
          Distinct Counts
        </a>
      </h3>
    <p>Distinct counts may be used to count the number of distinct values of a particular field within an explore.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> order_items <span class="token operator">|</span> <span class="token keyword">reduce</span> order_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token function_keyword">distinct</span> order_id<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore order_items | reduce order_count is count(distinct order_id)
  | ^</div>
      <h3>
        <a id="sums" class="header-link anchor" href="#sums">
          Sums
        </a>
      </h3>
    <p>The <code class="language-malloy">sum</code> function may be used to compute the sum of all records of a particular field.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> flights <span class="token operator">|</span> <span class="token keyword">reduce</span> total_distance <span class="token keyword">is</span> <span class="token function">sum</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore flights | reduce total_distance is sum(distance)
  | ^</div>
      <h3>
        <a id="averages" class="header-link anchor" href="#averages">
          Averages
        </a>
      </h3>
    <p>The <code class="language-malloy">avg</code> function may be used to compute the average of all records of a particular field.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> aircraft <span class="token operator">|</span> <span class="token keyword">reduce</span> average_seats <span class="token keyword">is</span> <span class="token function">sum</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore aircraft | reduce average_seats is sum(aircraft_models.seats)
  | ^</div>
      <h3>
        <a id="minima" class="header-link anchor" href="#minima">
          Minima
        </a>
      </h3>
    <p>The <code class="language-malloy">min</code> function may be used to compute the minimum of all records of a particular field.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> order_items <span class="token operator">|</span> <span class="token keyword">reduce</span> cheapest_price <span class="token keyword">is</span> <span class="token function">min</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore order_items | reduce cheapest_price is min(sale_price)
  | ^</div>
      <h3>
        <a id="maxima" class="header-link anchor" href="#maxima">
          Maxima
        </a>
      </h3>
    <p>The <code class="language-malloy">max</code> function may be used to compute the maximum of all records of a particular field.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> flights <span class="token operator">|</span> <span class="token keyword">reduce</span> longest_distance <span class="token keyword">is</span> <span class="token function">max</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore flights | reduce longest_distance is max(distance)
  | ^</div>
      <h2>
        <a id="aggregate-locality" class="header-link anchor" href="#aggregate-locality">
          Aggregate Locality
        </a>
      </h2>
    <p>In SQL, some kinds of aggregations are difficult to express because locality of aggregation is restricted to the top level of a query. Malloy
offers more control over this behavior, allowing these types of analysis to be
expressed much more easily.</p>

      <h3>
        <a id="the-problem" class="header-link anchor" href="#the-problem">
          The Problem
        </a>
      </h3>
    <p>Suppose you were interested in learning more about the number of seats on
commercial aircraft. First you might look at the average number of seats
on all registered aircraft.</p>
<p>To do this, you would start with the <code class="language-malloy">aircraft</code> table and join in <code class="language-malloy">aircraft_models</code> to get access to the number of seats, then take
the average of <code class="language-malloy">aircraft_models<span class="token punctuation">.</span>seats</code>.</p>
<pre class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> aircraft
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> aircraft_models
    <span class="token keyword">ON</span> aircraft<span class="token punctuation">.</span>aircraft_model_code <span class="token operator">=</span> aircraft_models<span class="token punctuation">.</span>aircraft_model_code</pre><pre class="language-malloy"><span class="token keyword">explore</span> aircraft
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  average_seats <span class="token keyword">is</span> <span class="token function">avg</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore aircraft
  | ^</div><p>You're also interested in knowing the average number of seats on the kinds of aircraft that are in use, or in other words, the average number of seats of the aircraft models of registered aircraft.</p>
<p>To do this, you might decide to start with the <code class="language-malloy">aircraft_models</code> table instead.</p>
<pre class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>seats<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> aircraft_models</pre><pre class="language-malloy"><span class="token keyword">explore</span> aircraft_models
<span class="token operator">|</span> <span class="token keyword">reduce</span> average_seats <span class="token keyword">is</span> <span class="token function">avg</span><span class="token punctuation">(</span>seats<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore aircraft_models
  | ^</div><p>However, this isn't actually the number you were interested in, because this measures the average number of seats across <em>all</em> aircraft models, not just the ones with actively-registered aircraft.</p>
<p>Unfortunately, SQL doesn't have any native constructs to compute this value, and in practice analysists often resort to complicated <a href="https://www.zentut.com/data-warehouse/fact-table/">fact tables</a> to perform this kind of query.</p>

      <h3>
        <a id="the-solution" class="header-link anchor" href="#the-solution">
          The Solution
        </a>
      </h3>
    <p>Malloy introduces the concept of <em>aggregate locality</em>, meaning that aggregates can be computed with respect to different points in the data graph. In the following query, <code class="language-malloy">average_seats</code> is computed with respect to <code class="language-malloy">aircraft_models</code>,
yielding the the average number of seats on aircraft models of aircraft listed in the <code class="language-malloy">aircraft</code> table.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> aircraft
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  average_seats <span class="token keyword">is</span> aircraft_models<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore aircraft
  | ^</div><p>For convenience, <code class="language-malloy">aircraft_models<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></code> can be written as <code class="language-malloy">aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code>.</p>

      <h3>
        <a id="examples" class="header-link anchor" href="#examples">
          Examples
        </a>
      </h3>
    <p>The following queries show six ways of calculating the average number of seats.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> flights
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  aircraft_models_avg_seats <span class="token keyword">is</span> aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  aircraft_avg_models_seats <span class="token keyword">is</span> aircraft<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span>
  avg_aircraft_models_seats <span class="token keyword">is</span> <span class="token function">avg</span><span class="token punctuation">(</span>aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore flights
  | ^</div><pre class="language-malloy"><span class="token keyword">explore</span> aircraft
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  models_avg_seats <span class="token keyword">is</span> aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  avg_models_seats <span class="token keyword">is</span> <span class="token function">avg</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore aircraft
  | ^</div><pre class="language-malloy"><span class="token keyword">explore</span> aircraft_models
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  avg_seats <span class="token keyword">is</span> <span class="token function">avg</span><span class="token punctuation">(</span>seats<span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore aircraft_models
  | ^</div><p>This table summarizes the meaning of each of these calculations.</p>
<table>
<thead>
<tr>
<th>Field Definition and Source</th>

<th>Is the average number of seats...</th>
</tr>
</thead>
<tbody><tr>
<td><code class="language-malloy"><span class="token function">avg</span><span class="token punctuation">(</span>seats<span class="token punctuation">)</span></code> in <code class="language-malloy">aircraft_models</code></td>

<td>...of all aircraft models.</td>
</tr>

<tr>
<td><code class="language-malloy"><span class="token function">avg</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></code> in <code class="language-malloy">aircraft</code></td>

<td>...on aircraft.</td>
</tr>

<tr>
<td><code class="language-malloy">aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> in <code class="language-malloy">aircraft</code></td>

<td>...of the aircraft models of aircraft.</td>
</tr>

<tr>
<td><code class="language-malloy"><span class="token function">avg</span><span class="token punctuation">(</span>aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></code> in <code class="language-malloy">flights</code></td>

<td>...on flights.</td>
</tr>

<tr>
<td><code class="language-malloy">aircraft<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></code> in <code class="language-malloy">flights</code></td>

<td>...on aircraft that fly.</td>
</tr>

<tr>
<td><code class="language-malloy">aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> in <code class="language-malloy">flights</code></td>

<td>...of the aircraft models of aircraft that fly.</td>
</tr>
</tbody></table>

      <h3>
        <a id="aggregates-that-support-locality" class="header-link anchor" href="#aggregates-that-support-locality">
          Aggregates that Support Locality
        </a>
      </h3>
    <p>The aggregate fuctions that support locality are <code class="language-malloy">count</code>, <code class="language-malloy">sum</code>, and <code class="language-malloy">avg</code>.</p>
<p>The <code class="language-malloy">min</code> and <code class="language-malloy">max</code> aggregates do not support aggregate locality because the minimum and maximum values are the same regardless of where they are computed. Local aggregation removes duplicate values (those corresponding to the same row in the aggregate source location), and minimum and maximum values do not change if values are repeated more than once.</p>

      <h3>
        <a id="aggregates-on-fields" class="header-link anchor" href="#aggregates-on-fields">
          Aggregates on Fields
        </a>
      </h3>
    <p>Aggregating "on a field," e.g. <code class="language-malloy">aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> is exactly equivalent to aggregating that field with respect to its direct parent explore, e.g. <code class="language-malloy">aircraft_models<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span></code>. This syntax is supported for the aggregate functions which benefit from aggregate locality and require a field, <code class="language-malloy">avg</code> and <code class="language-malloy">sum</code>.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> aircraft
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  avg_on_explore <span class="token keyword">is</span> aircraft_models<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span>
  avg_on_field <span class="token keyword">is</span> aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore aircraft
  | ^</div><!--
In SQL, it is easy to make mistakes when computing sums and averages,
particularly when joins are involved. An approach known as _symmetric aggregates_ solves one such common mistake by making the behavior of
aggregate functions consistent regardless of the structure of the query.

### The Problem

Consider a simple SQL query with an aggregate, like the following query,
which gives the average age of all users.

```sql
SELECT AVG(age)
FROM users
```

```malloy
--! {"isRunnable": true, "runMode": "auto", "source": "ecommerce/ecommerce.malloy"}
explore users
| reduce average_age is avg(age)
```

If we instead calculate the average age of users in a query against the
order items table joining in the users table, we get a different answer.

```sql
SELECT AVG(users.age)
FROM order_items
JOIN users ON order_items.user_id = users.id
```

```malloy
--! {"isRunnable": true, "runMode": "auto", "source": "ecommerce/ecommerce.malloy"}
explore order_items
| reduce users is avg(users.age)
```

The reason for this is that we're actually _not_ computing the average user age at all. To explain this, we'll look at a sample of the users table:

```sql
SELECT id, age
FROM users
LIMIT 5
ORDER BY id ASC
```

```malloy
--! {"isRunnable": true, "runMode": "auto", "source": "ecommerce/ecommerce.malloy", "pageSize": 20}
explore users
| project top 20 order by id
  id
  age
```

And we'll compare this to the composite table that is generated when you join `users` onto `order_items`.

```sql
SELECT order_items.id as order_item_id, users.id as user_id, age
FROM order_items
JOIN users ON order_items.user_id = users.id
```

```malloy
--! {"isRunnable": true, "runMode": "auto", "source": "ecommerce/ecommerce.malloy", "pageSize": 20}
explore order_items
| project top 20 order by order_items_id asc
  order_items_id is id
  user_id is users.id
  users.age
```

Here we can see that some `user_id`s appear more than once, and others not at all; so when we compute the average age over this table, we end up with the
average user age _weighted by number of items purchased_.

### The Solution

In SQL, a query containing a join first computes a composite table, then performs aggregations on it. In Malloy, the two steps can be logically combined so that aggregates are computed based on the primary key of the table that is joined in.

```malloy
--! {"isRunnable": true, "runMode": "auto", "source": "ecommerce/ecommerce.malloy"}
explore order_items
| reduce
  symmetric_avg is users.age.avg()
  asymmetric_avg is avg(users.age)
```


In SQL, when computing an aggregate such as a sum or an average, it is important
to do so against the base table in the <code>FROM</code> statement,
rather than against a combination table resulting from a join. Failing to do
so


In SQL, when you compute a sum or an average, you have to be computing it against the base table in the FROM statement.

`orders` -- only `orders.sum()` or or `avg(orders.whatever)`. If you try to compute an aggregate in something else, it's going to be wrong.

This makes it really easy to make mistakes. You can write a query, then add a join, and suddenly your query no longer works.

Simple example:

```sql
SELECT AVG(age) FROM users
```

44.3964

Add a JOIN

```sql
SELECT AVG(age) FROM users
JOIN orders on orders.user_id = users.id
```

45.4151

```sql
SELECT
  users.id AS user_id
  , users.age AS age
  -- , orders.id AS order_id
FROM users
-- LEFT JOIN orders ON orders.user_id = users.id
ORDER BY users.id
LIMIT 10
```

```sql
SELECT
  users.id AS user_id
  , users.age AS age
  , orders.id AS order_id
FROM users
LEFT JOIN orders ON orders.user_id = users.id
ORDER BY users.id
LIMIT 10
```

When orders is joined in, SQL makes a new table that is the combination table of users and orders, so each user is repeated by the number of times they made an order. Therefore, the average age is weighted by their number of orders.

In SQL, first you do the relations to build a joined table, then you do the aggregations. In Looker, the two steps are logically combined, so we aggregate as we join. The aggregates are computed based on the primary key of the table that you're joining into.

This radically simplifies the way that you write queries. --></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>