<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Malloy Documentation</title>
    <link rel="stylesheet" href="/malloy/css/document.css">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"/>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <div class="header-banner">
          <img src="/malloy/img/logo.png" alt="malloy logo"/>
          Malloy
          <span class="subtitle">Documentation</span>
        </div>
        <form onSubmit="() => alert('submit')" action="/malloy/search">
          <div class="search-input-outer">
            <img src="/malloy/img/search.svg" alt="search"/>
            <input placeholder="Search" id="search-input" name="query" />
          </div>
          <input type="submit" style="display: none" />
        </form>
      </div>
      <div class="main">
        <div class="sidebar" id="sidebar">
    <div>
        <div id=getting_started class="sidebar-section-title collapsed">Getting Started<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/index.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                The Tao of Malloy
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/features.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Key Features
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/connection_instructions.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Connecting a Database
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=language_reference class="sidebar-section-title collapsed">Language Reference<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/language/overview.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Introduction
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/basic.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Malloy Quickstart
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/statement.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Models
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/explore.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Explores
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/query.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Queries
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/fields.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Fields
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/types.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Types
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/expressions.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Expressions
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/order_by.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Ordering and Limiting
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/join.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Joins
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/filters.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Filters
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/nesting.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Nested Queries
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/aggregates.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Aggregates
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/imports.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Imports
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=common_patterns class="sidebar-section-title collapsed">Common Patterns<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/yoy.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Year Over Year Analysis
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/foreign_sums.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Foreign Sums and Averages
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/percent_of_total.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Percent of Total
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/cohorts.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Cohort Analysis
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/pivot_limits.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Pivot Limits
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/sessionize.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Sessionized Data
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=rendering_results class="sidebar-section-title collapsed">Rendering Results<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/dashboards.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Tables and Dashboards
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/bar_charts.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Bar Charts
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/charts_line_chart.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Line Charts
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/shape_maps.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Shape Maps
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/segment_maps.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Segment Maps
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/scatter_charts.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Scatter Charts
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=examples class="sidebar-section-title collapsed">Examples<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/examples/ecommerce.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                eCommerce Analysis
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/faa.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                NTSB Flight Database
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/names.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                The Name Game
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/ga_sessions.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Google Analytics GA360
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=walkthrough:_iowa liquor class="sidebar-section-title collapsed">Walkthrough: Iowa Liquor<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/iowa.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                About the Data Set
              </a>
            </div>
<div class='sidebar-item active'>
              <a href="/malloy/documentation/examples/iowa/source.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                The Malloy Data Model
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step2.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Basic Calculations
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step2a.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Analysis: Products and Brands
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step3.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Bucketing and Mapping
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step6.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Dashboards
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=walkthrough:_wordle solver class="sidebar-section-title collapsed">Walkthrough: Wordle Solver<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Just Words
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle1a.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Letters and Positioning
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle2.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Letter Frequency
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle3.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Scoring Words
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle4.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Final Model
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle5.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Solving Puzzles
              </a>
            </div>
          </div>
      </div>

  </div>
        <script src="/malloy/js/sidebar_state.js"></script>
        <div class="content">
          <div class="footer">
            
            <div class="linear-navigation">
    <div class="item">
      <a href="iowa.html"><img src="/malloy/img/previous.svg" alt="previous"/>About the Data Set</a>
    </div>
    <div class="item">
      <a href="step2.html">Basic Calculations<img src="/malloy/img/next.svg" alt="next"/></a>
    </div>
  </div>
            
          </div>
          <div class="document-outer">
            <div class="document">
      <h1>
        <a id="iowa-liquor-malloy-model" class="header-link anchor" href="#iowa-liquor-malloy-model">
          Iowa Liquor Malloy Model
        </a>
      </h1>
    <p>This is the malloy model used for the Analysis example.  It should be used as an reference when looking at the <a href="step2.html">following sections</a>.</p>
<pre class="language-malloy"><span class="token keyword">explore</span>: iowa <span class="token keyword">is</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'malloy-data.iowa_liquor_sales.sales_deduped'</span><span class="token punctuation">)</span>{

  <span class="token comment">-- dimensions</span>
  <span class="token keyword">dimension</span>: <span class="token punctuation">[</span>
    gross_margin <span class="token keyword">is</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token punctuation">(</span>state_bottle_retail <span class="token operator">-</span> state_bottle_cost<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">nullif</span><span class="token punctuation">(</span>state_bottle_retail<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    price_per_100ml <span class="token keyword">is</span> state_bottle_retail <span class="token operator">/</span> <span class="token function">nullif</span><span class="token punctuation">(</span>bottle_volume_ml<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>

    category_class <span class="token keyword">is</span> category_name :
      <span class="token keyword">pick</span> <span class="token string">'WHISKIES'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'(WHISK|SCOTCH|BOURBON|RYE)'</span>
      <span class="token keyword">pick</span> <span class="token string">'VODKAS'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'VODKA'</span>
      <span class="token keyword">pick</span> <span class="token string">'RUMS'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'RUM'</span>
      <span class="token keyword">pick</span> <span class="token string">'TEQUILAS'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'TEQUILA'</span>
      <span class="token keyword">pick</span> <span class="token string">'LIQUEURS'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'(LIQUE|AMARETTO|TRIPLE SEC)'</span>
      <span class="token keyword">pick</span> <span class="token string">'BRANDIES'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'BRAND(I|Y)'</span>
      <span class="token keyword">pick</span> <span class="token string">'GINS'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'GIN'</span>
      <span class="token keyword">pick</span> <span class="token string">'SCHNAPPS'</span> <span class="token keyword">when</span> <span class="token operator">~</span> <span class="token regular_expression">r'SCHNAP'</span>
      <span class="token keyword">else</span> <span class="token string">'OTHER'</span>

    bottle_size <span class="token keyword">is</span> bottle_volume_ml:
      <span class="token keyword">pick</span> <span class="token string">'jumbo (over 1000ml)'</span> <span class="token keyword">when</span> <span class="token operator">></span> <span class="token number">1001</span>
      <span class="token keyword">pick</span> <span class="token string">'liter-ish'</span> <span class="token keyword">when</span> <span class="token operator">>=</span> <span class="token number">750</span>
      <span class="token keyword">else</span> <span class="token string">'small or mini (under 750ml)'</span>
  <span class="token punctuation">]</span>

  <span class="token comment">-- measures</span>
  <span class="token keyword">measure</span>: <span class="token punctuation">[</span>
    total_sale_dollars <span class="token keyword">is</span> sale_dollars<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    item_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token function_keyword">distinct</span> item_number<span class="token punctuation">)</span>
    total_bottles <span class="token keyword">is</span> bottles_sold<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    line_item_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    avg_price_per_100ml <span class="token keyword">is</span> price_per_100ml<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>

  <span class="token comment">-- turtles</span>
  <span class="token keyword">query</span>: by_month <span class="token keyword">is</span> {
    <span class="token keyword">order_by</span>: <span class="token number">1</span>
    <span class="token keyword">group_by</span>: purchase_month <span class="token keyword">is</span> <span class="token identifier">`date`</span><span class="token punctuation">.</span><span class="token timeframe">week</span>
    <span class="token keyword">aggregate</span>: total_sale_dollars
  }

  <span class="token keyword">query</span>: top_sellers_by_revenue <span class="token keyword">is</span> {
    <span class="token keyword">top</span>: <span class="token number">5</span>
    <span class="token keyword">group_by</span>: <span class="token punctuation">[</span>
      vendor_name
      item_description
      total_sale_dollars
    <span class="token punctuation">]</span>
    <span class="token keyword">aggregate</span>: <span class="token punctuation">[</span>
      total_bottles
      avg_price_per_100ml
    <span class="token punctuation">]</span>
  }

  <span class="token keyword">query</span>: most_expensive_products <span class="token keyword">is</span> {
    <span class="token keyword">top</span>: <span class="token number">10</span>
    <span class="token keyword">order_by</span>: avg_price_per_100ml <span class="token keyword">desc</span>
    <span class="token keyword">group_by</span>: <span class="token punctuation">[</span>
      vendor_name
      item_description
    <span class="token punctuation">]</span>
    <span class="token keyword">aggregate</span>: <span class="token punctuation">[</span>
      total_sale_dollars
      total_bottles
      avg_price_per_100ml
    <span class="token punctuation">]</span>
  }

  <span class="token keyword">query</span>: by_vendor_bar_chart <span class="token keyword">is</span> {
    <span class="token keyword">top</span>: <span class="token number">10</span>
    <span class="token keyword">group_by</span>: vendor_name
    <span class="token keyword">aggregate</span>: <span class="token punctuation">[</span>
      total_sale_dollars
      total_bottles
    <span class="token punctuation">]</span>
  }

  <span class="token keyword">query</span>: by_class <span class="token keyword">is</span> {
    <span class="token keyword">top</span>: <span class="token number">10</span>
    <span class="token keyword">group_by</span>: category_class
    <span class="token keyword">aggregate</span>: <span class="token punctuation">[</span>
      total_sale_dollars
      item_count
    <span class="token punctuation">]</span>
  }

  <span class="token keyword">query</span>: by_category <span class="token keyword">is</span> {
    <span class="token keyword">top</span>: <span class="token number">10</span>
    <span class="token keyword">group_by</span>: category_name
    <span class="token keyword">aggregate</span>: <span class="token punctuation">[</span>
      total_sale_dollars
      item_count
    <span class="token punctuation">]</span>
  }

  <span class="token keyword">query</span>: by_sku <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: item_description
    <span class="token keyword">aggregate</span>: total_sale_dollars
    <span class="token keyword">limit</span>: <span class="token number">5</span>
  }

  <span class="token keyword">query</span>: vendor_dashboard <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: vendor_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token function_keyword">distinct</span> vendor_number<span class="token punctuation">)</span>
    <span class="token keyword">aggregate</span>: <span class="token punctuation">[</span>
      total_sale_dollars
      total_bottles
    <span class="token punctuation">]</span>
    <span class="token keyword">nest</span>: by_month
    <span class="token keyword">nest</span>: by_class
    <span class="token keyword">nest</span>: by_vendor_bar_chart
    <span class="token keyword">nest</span>: top_sellers_by_revenue
    <span class="token keyword">nest</span>: most_expensive_products
    <span class="token keyword">nest</span>: by_vendor_dashboard <span class="token keyword">is</span> {
      <span class="token keyword">top</span>: <span class="token number">10</span>
      <span class="token keyword">group_by</span>: vendor_name
      <span class="token keyword">aggregate</span>: total_sale_dollars
      <span class="token keyword">nest</span>: by_month
      <span class="token keyword">nest</span>: top_sellers_by_revenue
      <span class="token keyword">nest</span>: most_expensive_products
    }
  }
}</pre>
      <h2>
        <a id="schema-overview" class="header-link anchor" href="#schema-overview">
          Schema Overview
        </a>
      </h2>
    <p>The schema for the table <code class="language-malloy">bigquery<span class="token operator">-</span>public<span class="token operator">-</span>data<span class="token punctuation">.</span>iowa_liquor_sales<span class="token punctuation">.</span>sales</code> as well as descriptions of each field can be found on the <a href="https://data.iowa.gov/Sales-Distribution/Iowa-Liquor-Sales/m3tr-qhgy">Iowa Data site</a>.</p>
</div>
          </div>
        </div>
        <script src="/malloy/js/view_toggles.js"></script>
      </div>
    </div>
  </body>
</html>