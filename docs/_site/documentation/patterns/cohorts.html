<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Malloy Documentation</title>
    <link rel="stylesheet" href="/malloy/css/document.css">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"/>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <img src="/malloy/img/logo.png" alt="malloy logo"/>Malloy <span class="subtitle">Documentation</span>
      </div>
      <div class="main">
        <div class="sidebar">
    <div>
        <div class="sidebar-section-title">Getting Started</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/index.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Tao of Malloy
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/features.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Key Features
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Language Reference</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/language/overview.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Introduction
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/basic.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Malloy Quickstart
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/statement.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Models
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/explore.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Explores
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/query.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Queries
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/fields.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Fields
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/types.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Types
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/expressions.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Expressions
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/order_by.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Ordering and Limiting
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/join.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Joins
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/filters.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Filters
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/nesting.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Nested Queries
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/aggregates.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Aggregates
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/imports.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Imports and Exports
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Common Patterns</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/yoy.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Year Over Year Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/foreign_sums.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Foreign Sums and Averages
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/percent_of_total.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Percent of Total
            </a>
          </div>
<div class='sidebar-item active'>
            <a href="/malloy/documentation/patterns/cohorts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Cohort Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/pivot_limits.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Pivot Limits
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/sessionize.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Sessionized Data
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Rendering Results</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/dashboards.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Tables and Dashboards
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/bar_charts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Bar Charts
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/charts_line_chart.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Line Charts
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/shape_maps.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Shape Maps
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/segment_maps.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Segment Maps
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/scatter_charts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Scatter Charts
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Examples</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/examples/ecommerce.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              eCommerce Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/faa.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              NTSB Flight Database
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/names.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Name Game
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/ga_sessions.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Google Analytics GA360
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Iowa Liquor - An Analysis</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/iowa.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              About the Data Set
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/source.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Malloy Data Model
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step2.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Basic Calculations
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step2a.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Analysis: Products and Brands
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step3.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Bucketing and Mapping
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step6.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Dashboards
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Wordle - A Perfect Solver</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/examples/wordle/wordle.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Just Words
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/wordle/wordle1a.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Letters and Positioning
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/wordle/wordle2.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Letter Frequency
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/wordle/wordle3.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Scoring Words
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/wordle/wordle4.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Final Model
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/wordle/wordle5.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Solving Puzzles
            </a>
          </div>
      </div>

  </div>
        <div class="content">
          <div class="footer">
            
            <div class="linear-navigation">
    <div class="item">
      <a href="percent_of_total.html"><img src="/malloy/img/previous.svg" alt="previous"/>Percent of Total</a>
    </div>
    <div class="item">
      <a href="pivot_limits.html">Pivot Limits<img src="/malloy/img/next.svg" alt="next"/></a>
    </div>
  </div>
            
          </div>
          <div class="document-outer">
            <div class="document">
      <h1>
        <a id="cohort-analysis" class="header-link anchor" href="#cohort-analysis">
          Cohort Analysis
        </a>
      </h1>
    <p>One of the most powerful way of understanding what is happening using data is to use <em>cohort analisys</em>.
Fundementally, cohort analysis is used to group people into sets and to analyse the success,
attributes or characteristics of that group as compared to the population in general.</p>
<p>To understand this, we're going to use Social Security Administrations birth/name data.</p>
<p>We have a table with <code class="language-malloy">name</code>, <code class="language-malloy">gender</code>, <code class="language-malloy"><span class="token identifier">`year`</span></code>, <code class="language-malloy">state</code> and the <code class="language-malloy"><span class="token identifier">`number`</span></code> of people born with those
characterisitics.</p>
<p>In the simplelist form, a cohort calculation is a <a href="percent_of_total.html">percentage of total calculation</a>.
For example, if we were interested in the name 'Billie' as it relates to location. We could look
could filter on 'Billie' and look a states as it relates to total population.</p>
<p>We can see that in the population of the the people named 'Billie', the cohort of the Billies born in
Texas makes up 18% of the total population of Billies.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">where</span>: name <span class="token operator">=</span> <span class="token string">'Billie'</span>
  <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">nest</span>: main_query <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: state
    <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  }
}<span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">project</span>: <span class="token punctuation">[</span>
    main_query<span class="token punctuation">.</span>state
    main_query<span class="token punctuation">.</span>total_population
    state_as_percent_of_population <span class="token keyword">is</span> main_query<span class="token punctuation">.</span>total_population<span class="token operator">/</span>total_population <span class="token operator">*</span> <span class="token number">100.0</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">order_by</span>: <span class="token number">3</span> <span class="token keyword">desc</span>
}</pre><div class="result-outer small">
    <div class="result-middle">
      <div class="result-inner">
        <pre>[
  {
    "state": "TX",
    "total_population": 23052,
    "state_as_percent_of_population": 18.644300838718546
  },
  {
    "state": "OK",
    "total_population": 8409,
    "state_as_percent_of_population": 6.80114201599793
  },
  {
    "state": "TN",
    "total_population": 7368,
    "state_as_percent_of_population": 5.9591882951448145
  },
  {
    "state": "KY",
    "total_population": 6416,
    "state_as_percent_of_population": 5.189217169062042
  },
  {
    "state": "AR",
    "total_population": 5902,
    "state_as_percent_of_population": 4.773497464433319
  },
  {
    "state": "NC",
    "total_population": 5726,
    "state_as_percent_of_population": 4.631149861291966
  },
  {
    "state": "AL",
    "total_population": 5230,
    "state_as_percent_of_population": 4.229988434257245
  },
  {
    "state": "MO",
    "total_population": 4986,
    "state_as_percent_of_population": 4.032642893538551
  },
  {
    "state": "CA",
    "total_population": 4830,
    "state_as_percent_of_population": 3.906471154390534
  },
  {
    "state": "MS",
    "total_population": 4360,
    "state_as_percent_of_population": 3.5263383505471486
  },
  {
    "state": "OH",
    "total_population": 4344,
    "state_as_percent_of_population": 3.5133976593524805
  },
  {
    "state": "IL",
    "total_population": 3830,
    "state_as_percent_of_population": 3.0976779547237565
  },
  {
    "state": "GA",
    "total_population": 3598,
    "state_as_percent_of_population": 2.9100379324010643
  },
  {
    "state": "LA",
    "total_population": 3411,
    "state_as_percent_of_population": 2.758793604063377
  },
  {
    "state": "IN",
    "total_population": 2926,
    "state_as_percent_of_population": 2.3665289022249905
  },
  {
    "state": "WV",
    "total_population": 2863,
    "state_as_percent_of_population": 2.315574930645983
  },
  {
    "state": "PA",
    "total_population": 2605,
    "state_as_percent_of_population": 2.1069062851319544
  },
  {
    "state": "VA",
    "total_population": 2467,
    "state_as_percent_of_population": 1.9952928235779395
  },
  {
    "state": "MI",
    "total_population": 2340,
    "state_as_percent_of_population": 1.8925760872202588
  },
  {
    "state": "KS",
    "total_population": 2192,
    "state_as_percent_of_population": 1.7728746936695756
  }
]</pre>
      </div>
    </div>
  </div><p>We could run this same query, but instead look by decade to see when the Billies where born.
Using the query below we can see that 26% of all Billies were born in the 1930s.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">where</span>: name <span class="token operator">=</span> <span class="token string">'Billie'</span>
  <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">nest</span>: main_query <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: decade <span class="token keyword">is</span> <span class="token function">FLOOR</span><span class="token punctuation">(</span><span class="token identifier">`year`</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span>
    <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  }
}<span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">project</span>: <span class="token punctuation">[</span>
    main_query<span class="token punctuation">.</span>decade
    main_query<span class="token punctuation">.</span>total_population
    decade_as_percent_of_population <span class="token keyword">is</span> main_query<span class="token punctuation">.</span>total_population<span class="token operator">/</span>total_population <span class="token operator">*</span> <span class="token number">100.0</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">order_by</span>: <span class="token number">3</span> <span class="token keyword">desc</span>
}</pre><div class="result-outer small">
    <div class="result-middle">
      <div class="result-inner">
        <pre>[
  {
    "decade": 1930,
    "total_population": 32560,
    "decade_as_percent_of_population": 26.334306581150262
  },
  {
    "decade": 1920,
    "total_population": 27559,
    "decade_as_percent_of_population": 22.289531789616714
  },
  {
    "decade": 1940,
    "total_population": 19616,
    "decade_as_percent_of_population": 15.865287404663503
  },
  {
    "decade": 1950,
    "total_population": 13185,
    "decade_as_percent_of_population": 10.663938337606456
  },
  {
    "decade": 1970,
    "total_population": 10469,
    "decade_as_percent_of_population": 8.46725600731149
  },
  {
    "decade": 1960,
    "total_population": 8556,
    "decade_as_percent_of_population": 6.9200346163489455
  },
  {
    "decade": 1910,
    "total_population": 5349,
    "decade_as_percent_of_population": 4.3262348250175915
  },
  {
    "decade": 1980,
    "total_population": 4091,
    "decade_as_percent_of_population": 3.3087729798367853
  },
  {
    "decade": 1990,
    "total_population": 1646,
    "decade_as_percent_of_population": 1.3312736066515154
  },
  {
    "decade": 2000,
    "total_population": 456,
    "decade_as_percent_of_population": 0.3688096990480504
  },
  {
    "decade": 2010,
    "total_population": 154,
    "decade_as_percent_of_population": 0.1245541527486837
  }
]</pre>
      </div>
    </div>
  </div>
      <h2>
        <a id="names-as-cohorts" class="header-link anchor" href="#names-as-cohorts">
          Names as Cohorts
        </a>
      </h2>
    <p>In the above example, the population was <em>People named Billie</em> and we used <em>state</em> or <em>year</em> for our cohort (grouping).
Lets flip it around and look at people born with a particular name as a cohort and the other attributes to limit our popuation.
Let's limit our population to California in 1990 and look at the most cohorts (people with a given name).  We are also going
to measure a little differently.  Instead of looking at a percentage, let's look at births per 100,000 people.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">where</span>: state<span class="token operator">=</span> <span class="token string">'CA'</span> <span class="token keyword">and</span> <span class="token identifier">`year`</span> <span class="token operator">=</span> <span class="token number">1990</span>
  <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">nest</span>: main_query <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: name
    <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  }
}<span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">project</span>: <span class="token punctuation">[</span>
  main_query<span class="token punctuation">.</span>name
  main_query<span class="token punctuation">.</span>total_population
  births_per_100k <span class="token keyword">is</span> <span class="token function">FLOOR</span><span class="token punctuation">(</span>main_query<span class="token punctuation">.</span>total_population<span class="token operator">/</span>total_population <span class="token operator">*</span> <span class="token number">100000.0</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">order_by</span>: <span class="token number">3</span> <span class="token keyword">desc</span>
}</pre><div class="result-outer small">
    <div class="result-middle">
      <div class="result-inner">
        <pre>[
  {
    "name": "Michael",
    "total_population": 8306,
    "births_per_100k": 1504
  },
  {
    "name": "Jessica",
    "total_population": 6667,
    "births_per_100k": 1207
  },
  {
    "name": "Christopher",
    "total_population": 6665,
    "births_per_100k": 1207
  },
  {
    "name": "Daniel",
    "total_population": 5812,
    "births_per_100k": 1052
  },
  {
    "name": "David",
    "total_population": 5384,
    "births_per_100k": 975
  },
  {
    "name": "Jose",
    "total_population": 4971,
    "births_per_100k": 900
  },
  {
    "name": "Matthew",
    "total_population": 4914,
    "births_per_100k": 889
  },
  {
    "name": "Andrew",
    "total_population": 4576,
    "births_per_100k": 828
  },
  {
    "name": "Ashley",
    "total_population": 4565,
    "births_per_100k": 826
  },
  {
    "name": "Joshua",
    "total_population": 4329,
    "births_per_100k": 783
  },
  {
    "name": "Jonathan",
    "total_population": 4137,
    "births_per_100k": 749
  },
  {
    "name": "Anthony",
    "total_population": 4047,
    "births_per_100k": 732
  },
  {
    "name": "Stephanie",
    "total_population": 4029,
    "births_per_100k": 729
  },
  {
    "name": "Amanda",
    "total_population": 3868,
    "births_per_100k": 700
  },
  {
    "name": "Ryan",
    "total_population": 3686,
    "births_per_100k": 667
  },
  {
    "name": "Jennifer",
    "total_population": 3634,
    "births_per_100k": 658
  },
  {
    "name": "Robert",
    "total_population": 3618,
    "births_per_100k": 655
  },
  {
    "name": "Joseph",
    "total_population": 3595,
    "births_per_100k": 651
  },
  {
    "name": "Nicholas",
    "total_population": 3481,
    "births_per_100k": 630
  },
  {
    "name": "Kevin",
    "total_population": 3334,
    "births_per_100k": 603
  }
]</pre>
      </div>
    </div>
  </div></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>