<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Malloy Documentation</title>
    <link rel="stylesheet" href="/malloy/css/document.css">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"/>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <div class="header-banner">
          <img src="/malloy/img/logo.png" alt="malloy logo"/>
          Malloy
          <span class="subtitle">Documentation</span>
        </div>
        <form onSubmit="() => alert('submit')" action="/malloy/search">
          <div class="search-input-outer">
            <img src="/malloy/img/search.svg" alt="search"/>
            <input placeholder="Search" id="search-input" name="query" />
          </div>
          <input type="submit" style="display: none" />
        </form>
      </div>
      <div class="main">
        <div class="sidebar" id="sidebar">
    <div>
        <div id=getting_started class="sidebar-section-title collapsed">Getting Started<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/index.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                The Tao of Malloy
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/features.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Key Features
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/connection_instructions.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Connecting a Database
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=language_reference class="sidebar-section-title collapsed">Language Reference<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/language/overview.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Introduction
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/basic.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Malloy Quickstart
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/statement.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Models
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/explore.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Explores
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/query.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Queries
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/fields.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Fields
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/types.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Types
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/expressions.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Expressions
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/order_by.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Ordering and Limiting
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/join.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Joins
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/filters.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Filters
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/nesting.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Nested Queries
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/aggregates.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Aggregates
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/language/imports.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Imports
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=common_patterns class="sidebar-section-title collapsed">Common Patterns<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/yoy.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Year Over Year Analysis
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/foreign_sums.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Foreign Sums and Averages
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/percent_of_total.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Percent of Total
              </a>
            </div>
<div class='sidebar-item active'>
              <a href="/malloy/documentation/patterns/cohorts.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Cohort Analysis
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/pivot_limits.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Pivot Limits
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/patterns/sessionize.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Sessionized Data
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=rendering_results class="sidebar-section-title collapsed">Rendering Results<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/dashboards.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Tables and Dashboards
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/bar_charts.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Bar Charts
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/charts_line_chart.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Line Charts
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/shape_maps.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Shape Maps
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/segment_maps.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Segment Maps
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/visualizations/scatter_charts.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Scatter Charts
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=examples class="sidebar-section-title collapsed">Examples<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/examples/ecommerce.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                eCommerce Analysis
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/faa.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                NTSB Flight Database
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/names.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                The Name Game
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/ga_sessions.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Google Analytics GA360
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=walkthrough:_iowa liquor class="sidebar-section-title collapsed">Walkthrough: Iowa Liquor<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/iowa.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                About the Data Set
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/source.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                The Malloy Data Model
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step2.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Basic Calculations
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step2a.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Analysis: Products and Brands
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step3.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Bucketing and Mapping
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/iowa/step6.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Dashboards
              </a>
            </div>
          </div>
      </div>
<div>
        <div id=walkthrough:_wordle solver class="sidebar-section-title collapsed">Walkthrough: Wordle Solver<img class="chevron-open" src="/malloy/img/section_open.svg" alt="section open"/>
        <img class="chevron-closed" src="/malloy/img/section_close.svg" alt="section closed"/></div>
          <div class="sidebar-section-item-group">
          <div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Just Words
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle1a.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Letters and Positioning
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle2.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Letter Frequency
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle3.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Scoring Words
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle4.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Final Model
              </a>
            </div>
<div class='sidebar-item '>
              <a href="/malloy/documentation/examples/wordle/wordle5.html">
                <img src="/malloy/img/article_icon.svg" alt="document"/>
                Solving Puzzles
              </a>
            </div>
          </div>
      </div>

  </div>
        <script src="/malloy/js/sidebar_state.js"></script>
        <div class="content">
          <div class="footer">
            
            <div class="linear-navigation">
    <div class="item">
      <a href="percent_of_total.html"><img src="/malloy/img/previous.svg" alt="previous"/>Percent of Total</a>
    </div>
    <div class="item">
      <a href="pivot_limits.html">Pivot Limits<img src="/malloy/img/next.svg" alt="next"/></a>
    </div>
  </div>
            
          </div>
          <div class="document-outer">
            <div class="document">
      <h1>
        <a id="cohort-analysis" class="header-link anchor" href="#cohort-analysis">
          Cohort Analysis
        </a>
      </h1>
    <p>One of the most powerful way of understanding what is happening using data is to use <em>cohort analysis</em>.
Fundamentally, cohort analysis is used to group people into sets and to analyze the success,
attributes or characteristics of that group as compared to the population in general.</p>
<p>To understand this, we're going to use Social Security Administrations birth/name data.</p>
<p>We have a table with <code class="language-malloy">name</code>, <code class="language-malloy">gender</code>, <code class="language-malloy"><span class="token identifier">`year`</span></code>, <code class="language-malloy">state</code> and the <code class="language-malloy"><span class="token identifier">`number`</span></code> of people born with those
characteristics.</p>
<p>In the simplest form, a cohort calculation is a <a href="percent_of_total.html">percentage of total calculation</a>.
For example, if we were interested in the name 'Billie' as it relates to location. We could look
could filter on 'Billie' and look a states as it relates to total population.</p>
<p>We can see that in the population of the the people named 'Billie', the cohort of the Billies born in
Texas makes up 18% of the total population of Billies.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> {
  <span class="token keyword">where</span>: name <span class="token operator">=</span> <span class="token string">'Billie'</span>
  <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">nest</span>: main_query <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: state
    <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  }
} <span class="token operator">-</span><span class="token operator">></span> {
  <span class="token keyword">project</span>: <span class="token punctuation">[</span>
    main_query<span class="token punctuation">.</span>state
    main_query<span class="token punctuation">.</span>total_population
    state_as_percent_of_population <span class="token keyword">is</span> main_query<span class="token punctuation">.</span>total_population <span class="token operator">/</span> total_population <span class="token operator">*</span> <span class="token number">100.0</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">order_by</span>: state_as_percent_of_population <span class="token keyword">desc</span>
}</pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control"  data-result-kind="html">HTML</button>
        <button class="result-control" selected data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" >
      <div class="result-inner">
        <table style="border: 1px solid #eaeaea; vertical-align: top; border-bottom: 1px solid #eaeaea; border-collapse: collapse; width: 100%;">
		<thead>
			<tr>
				<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: left;">state</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">total_&#8203;population</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">state_&#8203;as_&#8203;percent_&#8203;of_&#8203;population</th>
      </tr>
		</thead>
		<tbody>
			<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">TX</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">23,052</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">18.644</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">OK</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">8,409</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">6.801</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">TN</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">7,368</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5.959</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">KY</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">6,416</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5.189</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">AR</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5,902</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4.773</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">NC</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5,726</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4.631</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">AL</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5,230</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4.23</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">MO</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,986</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4.033</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">CA</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,830</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3.906</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">MS</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,360</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3.526</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">OH</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,344</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3.513</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">IL</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,830</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3.098</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">GA</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,598</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2.91</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">LA</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,411</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2.759</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">IN</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,926</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2.367</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">WV</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,863</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2.316</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">PA</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,605</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2.107</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">VA</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,467</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1.995</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">MI</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,340</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1.893</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">KS</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,192</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1.773</td>
</tr>

		</tbody>
	</table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" selected>
      <div class="result-inner">
        <pre><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"TX"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">23052</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">18.644300838718546</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"OK"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">8409</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">6.80114201599793</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"TN"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">7368</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">5.9591882951448145</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"KY"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">6416</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">5.189217169062042</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"AR"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">5902</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">4.773497464433319</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"NC"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">5726</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">4.631149861291966</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"AL"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">5230</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">4.229988434257245</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"MO"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4986</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">4.032642893538551</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"CA"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4830</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">3.906471154390534</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"MS"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4360</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">3.5263383505471486</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"OH"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4344</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">3.5133976593524805</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"IL"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3830</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">3.0976779547237565</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"GA"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3598</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">2.9100379324010643</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"LA"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3411</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">2.758793604063377</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"IN"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">2926</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">2.3665289022249905</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"WV"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">2863</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">2.315574930645983</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"PA"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">2605</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">2.1069062851319544</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"VA"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">2467</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">1.9952928235779395</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"MI"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">2340</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">1.8925760872202588</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"KS"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">2192</span><span class="token punctuation">,</span>
    <span class="token property">"state_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">1.7728746936695756</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><span class="token keyword">WITH</span> __stage0 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    group_set<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">as</span> total_population__0<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> base<span class="token punctuation">.</span>state <span class="token keyword">END</span> <span class="token keyword">as</span> state__1<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">as</span> total_population__1
  <span class="token keyword">FROM</span> <span class="token punctuation">`</span>bigquery<span class="token operator">-</span><span class="token keyword">public</span><span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>usa_names<span class="token punctuation">.</span>usa_1910_2013<span class="token punctuation">`</span> <span class="token keyword">as</span> base
  <span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span>  group_set <span class="token keyword">FROM</span> UNNEST<span class="token punctuation">(</span>GENERATE_ARRAY<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">WHERE</span> base<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'Billie'</span>
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span>
<span class="token punctuation">)</span>
<span class="token punctuation">,</span> __stage1 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    ANY_VALUE<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> total_population__0 <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total_population<span class="token punctuation">,</span>
    ARRAY_AGG<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> STRUCT<span class="token punctuation">(</span>state__1 <span class="token keyword">as</span> state<span class="token punctuation">,</span> total_population__1 <span class="token keyword">as</span> total_population<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">IGNORE</span> NULLS  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  total_population__1 <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> main_query
  <span class="token keyword">FROM</span> __stage0
  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">1</span> <span class="token keyword">desc</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> 
   main_query_0<span class="token punctuation">.</span>state <span class="token keyword">as</span> state<span class="token punctuation">,</span>
   main_query_0<span class="token punctuation">.</span>total_population <span class="token keyword">as</span> total_population<span class="token punctuation">,</span>
   <span class="token punctuation">(</span>main_query_0<span class="token punctuation">.</span>total_population<span class="token operator">/</span>base<span class="token punctuation">.</span>total_population<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100.0</span> <span class="token keyword">as</span> state_as_percent_of_population
<span class="token keyword">FROM</span> <span class="token punctuation">`</span>__stage1<span class="token punctuation">`</span> <span class="token keyword">as</span> base
<span class="token punctuation">,</span> UNNEST<span class="token punctuation">(</span>base<span class="token punctuation">.</span>main_query<span class="token punctuation">)</span> <span class="token keyword">as</span> main_query_0
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">3</span> <span class="token keyword">desc</span>
</pre>
      </div>
    </div>
  </div><p>We could run this same query, but instead look by decade to see when the Billies where born.
Using the query below we can see that 26% of all Billies were born in the 1930s.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> {
  <span class="token keyword">where</span>: name <span class="token operator">=</span> <span class="token string">'Billie'</span>
  <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">nest</span>: main_query <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: decade <span class="token keyword">is</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token identifier">`year`</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span>
    <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  }
} <span class="token operator">-</span><span class="token operator">></span> {
  <span class="token keyword">project</span>: <span class="token punctuation">[</span>
    main_query<span class="token punctuation">.</span>decade
    main_query<span class="token punctuation">.</span>total_population
    decade_as_percent_of_population <span class="token keyword">is</span> main_query<span class="token punctuation">.</span>total_population <span class="token operator">/</span> total_population <span class="token operator">*</span> <span class="token number">100.0</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">order_by</span>: decade_as_percent_of_population <span class="token keyword">desc</span>
}</pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control"  data-result-kind="html">HTML</button>
        <button class="result-control" selected data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" >
      <div class="result-inner">
        <table style="border: 1px solid #eaeaea; vertical-align: top; border-bottom: 1px solid #eaeaea; border-collapse: collapse; width: 100%;">
		<thead>
			<tr>
				<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">decade</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">total_&#8203;population</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">decade_&#8203;as_&#8203;percent_&#8203;of_&#8203;population</th>
      </tr>
		</thead>
		<tbody>
			<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,930</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">32,560</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">26.334</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,920</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">27,559</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">22.29</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,940</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">19,616</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">15.865</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,950</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">13,185</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">10.664</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,970</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">10,469</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">8.467</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,960</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">8,556</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">6.92</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,910</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5,349</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4.326</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,980</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,091</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3.309</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,990</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,646</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1.331</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,000</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">456</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">0.369</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">2,010</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">154</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">0.125</td>
</tr>

		</tbody>
	</table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" selected>
      <div class="result-inner">
        <pre><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1930</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">32560</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">26.334306581150262</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1920</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">27559</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">22.289531789616714</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1940</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">19616</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">15.865287404663503</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1950</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">13185</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">10.663938337606456</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1970</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">10469</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">8.46725600731149</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1960</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">8556</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">6.9200346163489455</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1910</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">5349</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">4.3262348250175915</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1980</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4091</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">3.3087729798367853</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">1990</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">1646</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">1.3312736066515154</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">456</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">0.3688096990480504</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"decade"</span><span class="token operator">:</span> <span class="token number">2010</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">154</span><span class="token punctuation">,</span>
    <span class="token property">"decade_as_percent_of_population"</span><span class="token operator">:</span> <span class="token number">0.1245541527486837</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><span class="token keyword">WITH</span> __stage0 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    group_set<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">as</span> total_population__0<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token punctuation">(</span>floor<span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token keyword">year</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span> <span class="token keyword">END</span> <span class="token keyword">as</span> decade__1<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">as</span> total_population__1
  <span class="token keyword">FROM</span> <span class="token punctuation">`</span>bigquery<span class="token operator">-</span><span class="token keyword">public</span><span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>usa_names<span class="token punctuation">.</span>usa_1910_2013<span class="token punctuation">`</span> <span class="token keyword">as</span> base
  <span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span>  group_set <span class="token keyword">FROM</span> UNNEST<span class="token punctuation">(</span>GENERATE_ARRAY<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">WHERE</span> base<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'Billie'</span>
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span>
<span class="token punctuation">)</span>
<span class="token punctuation">,</span> __stage1 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    ANY_VALUE<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> total_population__0 <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total_population<span class="token punctuation">,</span>
    ARRAY_AGG<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> STRUCT<span class="token punctuation">(</span>decade__1 <span class="token keyword">as</span> decade<span class="token punctuation">,</span> total_population__1 <span class="token keyword">as</span> total_population<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">IGNORE</span> NULLS  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  total_population__1 <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> main_query
  <span class="token keyword">FROM</span> __stage0
  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">1</span> <span class="token keyword">desc</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> 
   main_query_0<span class="token punctuation">.</span>decade <span class="token keyword">as</span> decade<span class="token punctuation">,</span>
   main_query_0<span class="token punctuation">.</span>total_population <span class="token keyword">as</span> total_population<span class="token punctuation">,</span>
   <span class="token punctuation">(</span>main_query_0<span class="token punctuation">.</span>total_population<span class="token operator">/</span>base<span class="token punctuation">.</span>total_population<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100.0</span> <span class="token keyword">as</span> decade_as_percent_of_population
<span class="token keyword">FROM</span> <span class="token punctuation">`</span>__stage1<span class="token punctuation">`</span> <span class="token keyword">as</span> base
<span class="token punctuation">,</span> UNNEST<span class="token punctuation">(</span>base<span class="token punctuation">.</span>main_query<span class="token punctuation">)</span> <span class="token keyword">as</span> main_query_0
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">3</span> <span class="token keyword">desc</span>
</pre>
      </div>
    </div>
  </div>
      <h2>
        <a id="names-as-cohorts" class="header-link anchor" href="#names-as-cohorts">
          Names as Cohorts
        </a>
      </h2>
    <p>In the above example, the population was <em>People named Billie</em> and we used <em>state</em> or <em>year</em> for our cohort (grouping).
Lets flip it around and look at people born with a particular name as a cohort and the other attributes to limit our population.
Let's limit our population to California in 1990 and look at the most cohorts (people with a given name).  We are also going
to measure a little differently.  Instead of looking at a percentage, let's look at births per 100,000 people.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> {
  <span class="token keyword">where</span>: state <span class="token operator">=</span> <span class="token string">'CA'</span> <span class="token keyword">and</span> <span class="token identifier">`year`</span> <span class="token operator">=</span> <span class="token number">1990</span>
  <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">nest</span>: main_query <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: name
    <span class="token keyword">aggregate</span>: total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  }
} <span class="token operator">-</span><span class="token operator">></span> {
  <span class="token keyword">project</span>: <span class="token punctuation">[</span>
    main_query<span class="token punctuation">.</span>name
    main_query<span class="token punctuation">.</span>total_population
    births_per_100k <span class="token keyword">is</span> <span class="token function">FLOOR</span><span class="token punctuation">(</span>main_query<span class="token punctuation">.</span>total_population <span class="token operator">/</span> total_population <span class="token operator">*</span> <span class="token number">100000.0</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">order_by</span>: births_per_100k <span class="token keyword">desc</span>
}</pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control"  data-result-kind="html">HTML</button>
        <button class="result-control" selected data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" >
      <div class="result-inner">
        <table style="border: 1px solid #eaeaea; vertical-align: top; border-bottom: 1px solid #eaeaea; border-collapse: collapse; width: 100%;">
		<thead>
			<tr>
				<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: left;">name</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">total_&#8203;population</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">births_&#8203;per_&#8203;100k</th>
      </tr>
		</thead>
		<tbody>
			<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Michael</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">8,306</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,504</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Jessica</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">6,667</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,207</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Christopher</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">6,665</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,207</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Daniel</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5,812</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">1,052</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">David</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5,384</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">975</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Jose</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,971</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">900</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Matthew</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,914</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">889</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Andrew</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,576</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">828</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Ashley</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,565</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">826</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Joshua</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,329</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">783</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Jonathan</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,137</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">749</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Anthony</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,047</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">732</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Stephanie</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,029</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">729</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Amanda</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,868</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">700</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Ryan</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,686</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">667</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Jennifer</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,634</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">658</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Robert</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,618</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">655</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Joseph</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,595</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">651</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Nicholas</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,481</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">630</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">Kevin</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">3,334</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">603</td>
</tr>

		</tbody>
	</table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" selected>
      <div class="result-inner">
        <pre><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">8306</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">1504</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Jessica"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">6667</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">1207</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Christopher"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">6665</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">1207</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">5812</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">1052</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"David"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">5384</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">975</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Jose"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4971</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">900</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Matthew"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4914</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">889</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Andrew"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4576</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">828</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Ashley"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4565</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">826</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Joshua"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4329</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">783</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Jonathan"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4137</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">749</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Anthony"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4047</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">732</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Stephanie"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">4029</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">729</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Amanda"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3868</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">700</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Ryan"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3686</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">667</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Jennifer"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3634</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">658</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Robert"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3618</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">655</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Joseph"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3595</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">651</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Nicholas"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3481</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">630</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Kevin"</span><span class="token punctuation">,</span>
    <span class="token property">"total_population"</span><span class="token operator">:</span> <span class="token number">3334</span><span class="token punctuation">,</span>
    <span class="token property">"births_per_100k"</span><span class="token operator">:</span> <span class="token number">603</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><span class="token keyword">WITH</span> __stage0 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    group_set<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">as</span> total_population__0<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> base<span class="token punctuation">.</span>name <span class="token keyword">END</span> <span class="token keyword">as</span> name__1<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token function">SUM</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">as</span> total_population__1
  <span class="token keyword">FROM</span> <span class="token punctuation">`</span>bigquery<span class="token operator">-</span><span class="token keyword">public</span><span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>usa_names<span class="token punctuation">.</span>usa_1910_2013<span class="token punctuation">`</span> <span class="token keyword">as</span> base
  <span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span>  group_set <span class="token keyword">FROM</span> UNNEST<span class="token punctuation">(</span>GENERATE_ARRAY<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>base<span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token string">'CA'</span><span class="token punctuation">)</span><span class="token operator">and</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token keyword">year</span><span class="token operator">=</span><span class="token number">1990</span><span class="token punctuation">)</span>
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span>
<span class="token punctuation">)</span>
<span class="token punctuation">,</span> __stage1 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    ANY_VALUE<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> total_population__0 <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total_population<span class="token punctuation">,</span>
    ARRAY_AGG<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> group_set<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> STRUCT<span class="token punctuation">(</span>name__1 <span class="token keyword">as</span> name<span class="token punctuation">,</span> total_population__1 <span class="token keyword">as</span> total_population<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">IGNORE</span> NULLS  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  total_population__1 <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> main_query
  <span class="token keyword">FROM</span> __stage0
  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">1</span> <span class="token keyword">desc</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> 
   main_query_0<span class="token punctuation">.</span>name <span class="token keyword">as</span> name<span class="token punctuation">,</span>
   main_query_0<span class="token punctuation">.</span>total_population <span class="token keyword">as</span> total_population<span class="token punctuation">,</span>
   FLOOR<span class="token punctuation">(</span><span class="token punctuation">(</span>main_query_0<span class="token punctuation">.</span>total_population<span class="token operator">/</span>base<span class="token punctuation">.</span>total_population<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000.0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> births_per_100k
<span class="token keyword">FROM</span> <span class="token punctuation">`</span>__stage1<span class="token punctuation">`</span> <span class="token keyword">as</span> base
<span class="token punctuation">,</span> UNNEST<span class="token punctuation">(</span>base<span class="token punctuation">.</span>main_query<span class="token punctuation">)</span> <span class="token keyword">as</span> main_query_0
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">3</span> <span class="token keyword">desc</span>
</pre>
      </div>
    </div>
  </div></div>
          </div>
        </div>
        <script src="/malloy/js/view_toggles.js"></script>
      </div>
    </div>
  </body>
</html>