<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Malloy Documentation</title>
    <link rel="stylesheet" href="/malloy/css/document.css">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"/>
  </head>
  <body>
    <div class="top">
      <div class="header">
        <img src="/malloy/img/logo.png" alt="malloy logo"/>Malloy <span class="subtitle">Documentation</span>
      </div>
      <div class="main">
        <div class="sidebar">
    <div>
        <div class="sidebar-section-title">Getting Started</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/index.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Tao of Malloy
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/features.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Key Features
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Language Reference</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/language/overview.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Introduction
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/basic.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Malloy Quickstart
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/statement.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Models
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/explore.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Explores
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/query.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Queries
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/fields.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Fields
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/types.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Types
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/expressions.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Expressions
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/order_by.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Ordering and Limiting
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/join.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Joins
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/filters.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Filters
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/nesting.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Nested Queries
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/aggregates.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Aggregates
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/language/imports.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Imports and Exports
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Common Patterns</div>
        <div class='sidebar-item active'>
            <a href="/malloy/documentation/patterns/yoy.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Year Over Year Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/foreign_sums.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Foreign Sums and Averages
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/percent_of_total.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Percent of Total
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/cohorts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Cohort Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/pivot_limits.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Pivot Limits
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/patterns/sessionize.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Sessionized Data
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Visualizations</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/bar_charts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Bar Charts
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/charts_line_chart.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Line Charts
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/shape_maps.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Shape Maps
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/segment_maps.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Segment Maps
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/visualizations/scatter_charts.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Scatter Charts
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Examples</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/examples/ecommerce.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              eCommerce Analysis
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/faa.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              NTSB Flight Database
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/names.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Name Game
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/ga_sessions.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Google Analytics GA360
            </a>
          </div>
      </div>
<div>
        <div class="sidebar-section-title">Iowa Liquor - An Analysis</div>
        <div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/iowa.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              About the Data Set
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/source.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              The Malloy Data Model
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step2.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Basic Calculations
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step2a.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Analysis: Products and Brands
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step3.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Bucketing and Mapping
            </a>
          </div>
<div class='sidebar-item '>
            <a href="/malloy/documentation/examples/iowa/step6.html">
              <img src="/malloy/img/docs-page.svg" alt="document"/>
              Dashboards
            </a>
          </div>
      </div>

  </div>
        <div class="content">
          <div class="footer">
            
            <div class="linear-navigation">
    <div class="item">
      <a href="../language/imports.html"><img src="/malloy/img/previous.svg" alt="previous"/>Imports and Exports</a>
    </div>
    <div class="item">
      <a href="foreign_sums.html">Foreign Sums and Averages<img src="/malloy/img/next.svg" alt="next"/></a>
    </div>
  </div>
            
          </div>
          <div class="document-outer">
            <div class="document">
      <h1>
        <a id="year-over-year-analysis" class="header-link anchor" href="#year-over-year-analysis">
          Year Over Year Analysis
        </a>
      </h1>
    <p>There are a couple of different ways to go about this in Malloy.</p>

      <h2>
        <a id="method-1-pivoting-a-visualization" class="header-link anchor" href="#method-1-pivoting-a-visualization">
          Method 1: Pivoting a Visualization
        </a>
      </h2>
    <p>Compare performace of different years on the same scale.  Line charts take the X-Axis, Y-Axis and Dimensional Axis as parameters.
In this Case, the X-Axis is <code class="language-malloy">month_of_year</code>, the Y-Axis is <code class="language-malloy">flight_count</code> and the Dimensional Axis is the year.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> <span class="token string">'malloy-data.faa.flights'</span>
    flight_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  year_over_year <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
    month_of_year <span class="token keyword">is</span> <span class="token timeframe">month</span><span class="token punctuation">(</span>dep_time<span class="token punctuation">)</span>
    flight_count
    flight_year <span class="token keyword">is</span> dep_time<span class="token punctuation">.</span><span class="token timeframe">year</span>
  <span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 1: mismatched input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore 'malloy-data.faa.flights'
  | ^</div>
      <h2>
        <a id="method-2-filtered-aggregates" class="header-link anchor" href="#method-2-filtered-aggregates">
          Method 2: Filtered Aggregates
        </a>
      </h2>
    <p>Filters make it easy to reuse aggreate calculations for trends analysis.</p>
<pre class="language-malloy"><span class="token comment">-- common calculation for flights</span>
<span class="token keyword">define</span> flights <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token string">'malloy-data.faa.flights'</span>
  flight_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">explore</span> flights
<span class="token operator">|</span> <span class="token keyword">reduce</span> <span class="token keyword">top</span> <span class="token number">10</span>
  carrier
  flights_in_2002 <span class="token keyword">is</span> flight_count : <span class="token punctuation">[</span>dep_time : <span class="token date">@2003</span><span class="token punctuation">]</span>
  flights_in_2003 <span class="token keyword">is</span> flight_count : <span class="token punctuation">[</span>dep_time : <span class="token date">@2002</span><span class="token punctuation">]</span>
  percent_change <span class="token keyword">is</span> <span class="token function">round</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>flight_count : <span class="token punctuation">[</span>dep_time : <span class="token date">@2003</span><span class="token punctuation">]</span> <span class="token operator">-</span> flight_count : <span class="token punctuation">[</span>dep_time : <span class="token date">@2002</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token operator">/</span> <span class="token function">NULLIF</span><span class="token punctuation">(</span> flight_count : <span class="token punctuation">[</span>dep_time : <span class="token date">@2003</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>
    <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: mismatched input 'define' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | define flights is ('malloy-data.faa.flights'
  | ^</div>
      <h3>
        <a id="using-relative-timeframes" class="header-link anchor" href="#using-relative-timeframes">
          Using Relative Timeframes
        </a>
      </h3>
    <p>Often you want to show up-to-date information.  You can write timeframes relatively so the queries always show
current data.  Read more about it in the <a href="filter_expressions.html">filters</a> section.</p>
<pre class="language-malloy"><span class="token comment">-- common calculation for order_items</span>
<span class="token keyword">define</span> inventory_items <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">explore</span> <span class="token string">'malloy-data.ecomm.inventory_items'</span>
  primary <span class="token keyword">key</span> id
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">define</span> order_items <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token string">'malloy-data.ecomm.order_items'</span>
  inventory_items <span class="token keyword">is</span> <span class="token keyword">join</span> <span class="token keyword">on</span> inventory_item_id
  order_item_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">explore</span> order_items
<span class="token operator">|</span> <span class="token keyword">reduce</span> <span class="token keyword">top</span> <span class="token number">10</span>
    inventory_items<span class="token punctuation">.</span>product_category
    last_year <span class="token keyword">is</span> order_item_count : <span class="token punctuation">[</span>created_at : now<span class="token punctuation">.</span><span class="token timeframe">year</span><span class="token operator">-</span><span class="token number">1</span> <span class="token timeframe">year</span><span class="token punctuation">]</span>
    prior_year <span class="token keyword">is</span> order_item_count : <span class="token punctuation">[</span>created_at : now<span class="token punctuation">.</span><span class="token timeframe">year</span><span class="token operator">-</span><span class="token number">2</span> <span class="token timeframe">year</span><span class="token punctuation">]</span>
    percent_change <span class="token keyword">is</span> <span class="token function">round</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>order_item_count : <span class="token punctuation">[</span>created_at : now<span class="token punctuation">.</span><span class="token timeframe">year</span><span class="token operator">-</span><span class="token number">1</span> <span class="token timeframe">year</span><span class="token punctuation">]</span> <span class="token operator">-</span> order_item_count : <span class="token punctuation">[</span>created_at : now<span class="token punctuation">.</span><span class="token timeframe">year</span><span class="token operator">-</span><span class="token number">2</span> <span class="token timeframe">year</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token operator">/</span> <span class="token function">NULLIF</span><span class="token punctuation">(</span>order_item_count : <span class="token punctuation">[</span>created_at : now<span class="token punctuation">.</span><span class="token timeframe">year</span><span class="token operator">-</span><span class="token number">2</span> <span class="token timeframe">year</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>
      <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: mismatched input 'define' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | define inventory_items is (explore 'malloy-data.ecomm.inventory_items'
  | ^</div>
      <h3>
        <a id="declaring-and-reusing-common-expressions" class="header-link anchor" href="#declaring-and-reusing-common-expressions">
          Declaring and reusing common expressions
        </a>
      </h3>
    <p>We can rewrite the query so it is more reusable.  The declarations after the explore are temporary additions to this order_items table for the sake of just this query.</p>
<pre class="language-malloy"><span class="token comment">-- common calculation for order_items</span>
<span class="token keyword">define</span> inventory_items <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">explore</span> <span class="token string">'malloy-data.ecomm.inventory_items'</span>
  primary <span class="token keyword">key</span> id
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">define</span> order_items <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token string">'malloy-data.ecomm.order_items'</span>
  inventory_items <span class="token keyword">is</span> <span class="token keyword">join</span> <span class="token keyword">on</span> inventory_item_id
  order_item_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">explore</span> order_items
    last_year <span class="token keyword">is</span> order_item_count : <span class="token punctuation">[</span>created_at : now<span class="token punctuation">.</span><span class="token timeframe">year</span><span class="token operator">-</span><span class="token number">1</span> <span class="token timeframe">year</span><span class="token punctuation">]</span>
    prior_year <span class="token keyword">is</span> order_item_count : <span class="token punctuation">[</span>created_at : now<span class="token punctuation">.</span><span class="token timeframe">year</span><span class="token operator">-</span><span class="token number">2</span> <span class="token timeframe">year</span><span class="token punctuation">]</span>
    percent_change <span class="token keyword">is</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>last_year <span class="token operator">-</span> prior_year<span class="token punctuation">)</span>
        <span class="token operator">/</span> <span class="token function">NULLIF</span><span class="token punctuation">(</span>prior_year<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">reduce</span> <span class="token keyword">top</span> <span class="token number">10</span>
  inventory_items<span class="token punctuation">.</span>product_category
  last_year
  prior_year
  percent_change</pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: mismatched input 'define' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | define inventory_items is (explore 'malloy-data.ecomm.inventory_items'
  | ^</div></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>