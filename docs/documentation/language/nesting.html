---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/language/nesting.html
---

<div class="document">
      <h1>
        <a id="nested-queries" class="header-link anchor" href="#nested-queries">
          Nested Queries
        </a>
      </h1>
    <p>Nested queries, more formally known as "aggregating subqueries" are queries included in other queries. A nested query produces a subtable per row in the query in which it is embedded. In Malloy, queries can be named and referenced in other queries. The technical term "aggregating subquery" is a bit of a mouthful, so we more often refer to it as a "nested query."</p>
<p>When a named query is nested inside of another query, it produces an aggregating subquery and the results include a nested subtable.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> airports <span class="token operator">|</span> <span class="token keyword">reduce</span>
  state
  airport_count
  by_facility <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
    fac_type
    airport_count
  <span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore airports | reduce
  | ^</div>
      <h2>
        <a id="nesting-nested-queries" class="header-link anchor" href="#nesting-nested-queries">
          Nesting Nested Queries
        </a>
      </h2>
    <p>Aggregating subqueries can be nested infinitely, meaning that a nested query can contain another nested query.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> airports
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  state
  airport_count
  top_5_counties <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span> <span class="token keyword">top</span> <span class="token number">5</span>
    county
    airport_count
    by_facility <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
      fac_type
      airport_count
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore airports
  | ^</div>
      <h2>
        <a id="filtering-nested-queries" class="header-link anchor" href="#filtering-nested-queries">
          Filtering Nested Queries
        </a>
      </h2>
    <p>Filters can be applied at any level within nested queries.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> airports
<span class="token operator">|</span> <span class="token keyword">reduce</span> : <span class="token punctuation">[</span>state : <span class="token string">'CA'</span><span class="token operator">|</span><span class="token string">'NY'</span><span class="token operator">|</span><span class="token string">'MN'</span><span class="token punctuation">]</span>
  state
  airport_count
  top_5_counties <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span> <span class="token keyword">top</span> <span class="token number">5</span>
    county
    airport_count
    major_facilities <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span> : <span class="token punctuation">[</span>major:<span class="token string">'Y'</span><span class="token punctuation">]</span>
      name <span class="token keyword">is</span> <span class="token function">concat</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">' - '</span><span class="token punctuation">,</span> full_name<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    by_facility <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
      fac_type
      airport_count
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 2: extraneous input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore airports
  | ^</div></div>