---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/language/nesting.html
---

<div class="document">
      <h1>
        <a id="nested-queries" class="header-link anchor" href="#nested-queries">
          Nested Queries
        </a>
      </h1>
    <p>Nested queries, more formally known as "aggregating subqueries" are queries included in other queries. A nested query produces a subtable per row in the query in which it is embedded. In Malloy, queries can be named and referenced in other queries. The technical term "aggregating subquery" is a bit of a mouthful, so we more often refer to it as a "nested query."</p>
<p>When a named query is nested inside of another query, it produces an aggregating subquery and the results include a nested subtable.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: airports<span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">group_by</span>: state
  <span class="token keyword">aggregate</span>: airport_count
  <span class="token keyword">nest</span>: by_facility <span class="token keyword">is</span> {
    <span class="token keyword">group_by</span>: fac_type
    <span class="token keyword">aggregate</span>: airport_count
  }
}</pre><div class="result-outer small">
    <div class="result-middle">
      <div class="result-inner">
        <pre>[
  {
    "state": "TX",
    "airport_count": 1845,
    "by_facility": [
      {
        "fac_type": "AIRPORT",
        "airport_count": 1389
      },
      {
        "fac_type": "HELIPORT",
        "airport_count": 435
      },
      {
        "fac_type": "STOLPORT",
        "airport_count": 8
      },
      {
        "fac_type": "ULTRALIGHT",
        "airport_count": 8
      },
      {
        "fac_type": "GLIDERPORT",
        "airport_count": 5
      }
    ]
  },
  {
    "state": "CA",
    "airport_count": 984,
    "by_facility": [
      {
        "fac_type": "AIRPORT",
        "airport_count": 569
      },
      {
        "fac_type": "HELIPORT",
        "airport_count": 396
      },
      {
        "fac_type": "SEAPLANE BASE",
        "airport_count": 12
      },
      {
        "fac_type": "GLIDERPORT",
        "airport_count": 3
      },
      {
        "fac_type": "STOLPORT",
        "airport_count": 2
      },
      {
        "fac_type": "ULTRALIGHT",
        "airport_count": 2
      }
    ]
  },
  {
    "state": "IL",
    "airport_count": 890,
    "by_facility": [
      {
        "fac_type": "AIRPORT",
        "airport_count": 625
      },
      {
        "fac_type": "HELIPORT",
        "airport_count": 245
      },
      {
        "fac_type": "SEAPLANE BASE",
        "airport_count": 8
      },
      {
        "fac_type": "ULTRALIGHT",
        "airport_count": 6
      },
      {
        "fac_type": "STOLPORT",
        "airport_count": 2
      },
      {
        "fac_type": "GLIDERPORT",
        "airport_count": 2
      },
      {
        "fac_type": "BALLOONPORT",
        "airport_count": 2
      }
    ]
  },
  {
    "state": "FL",
    "airport_count": 856,
    "by_facility": [
      {
        "fac_type": "AIRPORT",
        "airport_count": 511
      },
      {
        "fac_type": "HELIPORT",
        "airport_count": 280
      },
      {
        "fac_type": "SEAPLANE BASE",
        "airport_count": 43
      },
      {
        "fac_type": "STOLPORT",
        "airport_count": 13
      },
      {
        "fac_type": "ULTRALIGHT",
        "airport_count": 5
      },
      {
        "fac_type": "GLIDERPORT",
        "airport_count": 4
      }
    ]
  },
  {
    "state": "PA",
    "airport_count": 804,
    "by_facility": [
      {
        "fac_type": "AIRPORT",
        "airport_count": 468
      },
      {
        "fac_type": "HELIPORT",
        "airport_count": 307
      },
      {
        "fac_type": "ULTRALIGHT",
        "airport_count": 13
      },
      {
        "fac_type": "SEAPLANE BASE",
        "airport_count": 10
      },
      {
        "fac_type": "STOLPORT",
        "airport_count": 3
      },
      {
        "fac_type": "GLIDERPORT",
        "airport_count": 3
      }
    ]
  }
]</pre>
      </div>
    </div>
  </div>
      <h2>
        <a id="nesting-nested-queries" class="header-link anchor" href="#nesting-nested-queries">
          Nesting Nested Queries
        </a>
      </h2>
    <p>Aggregating subqueries can be nested infinitely, meaning that a nested query can contain another nested query.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: airports<span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">group_by</span>: state
  <span class="token keyword">aggregate</span>: airport_count
  <span class="token keyword">nest</span>: top_5_counties <span class="token keyword">is</span> {
    <span class="token keyword">top</span>: <span class="token number">5</span>
    <span class="token keyword">group_by</span>: county
    <span class="token keyword">aggregate</span>: airport_count
    <span class="token keyword">nest</span>: by_facility <span class="token keyword">is</span> {
      <span class="token keyword">group_by</span>: fac_type
      <span class="token keyword">aggregate</span>: airport_count
    }
  }
}</pre><div class="result-outer large">
    <div class="result-middle">
      <div class="result-inner">
        <pre>[
  {
    "state": "TX",
    "airport_count": 1845,
    "top_5_counties": [
      {
        "county": "HARRIS",
        "airport_count": 135,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 110
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 25
          }
        ]
      },
      {
        "county": "TARRANT",
        "airport_count": 63,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 35
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 26
          },
          {
            "fac_type": "ULTRALIGHT",
            "airport_count": 1
          },
          {
            "fac_type": "STOLPORT",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "DENTON",
        "airport_count": 53,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 47
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 6
          }
        ]
      },
      {
        "county": "DALLAS",
        "airport_count": 42,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 32
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 9
          },
          {
            "fac_type": "STOLPORT",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "BEXAR",
        "airport_count": 40,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 24
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 16
          }
        ]
      }
    ]
  },
  {
    "state": "CA",
    "airport_count": 984,
    "top_5_counties": [
      {
        "county": "LOS ANGELES",
        "airport_count": 176,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 151
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 23
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 2
          }
        ]
      },
      {
        "county": "SAN BERNARDINO",
        "airport_count": 71,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 47
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 24
          }
        ]
      },
      {
        "county": "ORANGE",
        "airport_count": 53,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 47
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 6
          }
        ]
      },
      {
        "county": "SAN DIEGO",
        "airport_count": 49,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 30
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 17
          },
          {
            "fac_type": "GLIDERPORT",
            "airport_count": 2
          }
        ]
      },
      {
        "county": "KERN",
        "airport_count": 49,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 41
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 7
          },
          {
            "fac_type": "ULTRALIGHT",
            "airport_count": 1
          }
        ]
      }
    ]
  },
  {
    "state": "IL",
    "airport_count": 890,
    "top_5_counties": [
      {
        "county": "COOK",
        "airport_count": 51,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 44
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 7
          }
        ]
      },
      {
        "county": "LA SALLE",
        "airport_count": 39,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 35
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 4
          }
        ]
      },
      {
        "county": "MC HENRY",
        "airport_count": 29,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 20
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 7
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 2
          }
        ]
      },
      {
        "county": "DE KALB",
        "airport_count": 27,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 24
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 3
          }
        ]
      },
      {
        "county": "WINNEBAGO",
        "airport_count": 24,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 15
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 9
          }
        ]
      }
    ]
  },
  {
    "state": "FL",
    "airport_count": 856,
    "top_5_counties": [
      {
        "county": "PALM BEACH",
        "airport_count": 45,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 30
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 14
          },
          {
            "fac_type": "GLIDERPORT",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "DADE",
        "airport_count": 44,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 27
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 12
          },
          {
            "fac_type": "GLIDERPORT",
            "airport_count": 2
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 2
          },
          {
            "fac_type": "STOLPORT",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "POLK",
        "airport_count": 43,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 18
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 16
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 9
          }
        ]
      },
      {
        "county": "MARION",
        "airport_count": 37,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 27
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 7
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 2
          },
          {
            "fac_type": "STOLPORT",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "ORANGE",
        "airport_count": 36,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 24
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 8
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 4
          }
        ]
      }
    ]
  },
  {
    "state": "PA",
    "airport_count": 804,
    "top_5_counties": [
      {
        "county": "BUCKS",
        "airport_count": 55,
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 32
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 19
          },
          {
            "fac_type": "ULTRALIGHT",
            "airport_count": 2
          },
          {
            "fac_type": "STOLPORT",
            "airport_count": 1
          },
          {
            "fac_type": "GLIDERPORT",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "MONTGOMERY",
        "airport_count": 44,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 29
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 14
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "ALLEGHENY",
        "airport_count": 31,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 22
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 8
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "CHESTER",
        "airport_count": 27,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 16
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 11
          }
        ]
      },
      {
        "county": "PHILADELPHIA",
        "airport_count": 26,
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 22
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 4
          }
        ]
      }
    ]
  }
]</pre>
      </div>
    </div>
  </div>
      <h2>
        <a id="filtering-nested-queries" class="header-link anchor" href="#filtering-nested-queries">
          Filtering Nested Queries
        </a>
      </h2>
    <p>Filters can be applied at any level within nested queries.</p>
<pre class="language-malloy"><span class="token keyword">query</span>: airports<span class="token operator">-</span><span class="token operator">></span>{
  <span class="token keyword">where</span>: state: <span class="token string">'CA'</span><span class="token operator">|</span><span class="token string">'NY'</span><span class="token operator">|</span><span class="token string">'MN'</span>
  <span class="token keyword">group_by</span>: state
  <span class="token keyword">aggregate</span>: airport_count
  <span class="token keyword">nest</span>: top_5_counties <span class="token keyword">is</span> {
    <span class="token keyword">top</span>: <span class="token number">5</span>
    <span class="token keyword">group_by</span>: county
    <span class="token keyword">aggregate</span>: airport_count
    <span class="token keyword">nest</span>: major_facilities <span class="token keyword">is</span> {
      <span class="token keyword">where</span>: major:<span class="token string">'Y'</span>
      <span class="token keyword">group_by</span>: name <span class="token keyword">is</span> <span class="token function">concat</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">' - '</span><span class="token punctuation">,</span> full_name<span class="token punctuation">)</span>
    }
    <span class="token keyword">nest</span>: by_facility <span class="token keyword">is</span> {
      <span class="token keyword">group_by</span>: fac_type
      <span class="token keyword">aggregate</span>: airport_count
    }
  }
}</pre><div class="result-outer large">
    <div class="result-middle">
      <div class="result-inner">
        <pre>[
  {
    "state": "CA",
    "airport_count": 984,
    "top_5_counties": [
      {
        "county": "LOS ANGELES",
        "airport_count": 176,
        "major_facilities": [
          {
            "name": "BUR - BURBANK-GLENDALE-PASADENA"
          },
          {
            "name": "LAX - LOS ANGELES INTL"
          },
          {
            "name": "LGB - LONG BEACH /DAUGHERTY FIELD/"
          }
        ],
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 151
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 23
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 2
          }
        ]
      },
      {
        "county": "SAN BERNARDINO",
        "airport_count": 71,
        "major_facilities": [
          {
            "name": "ONT - ONTARIO INTL"
          }
        ],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 47
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 24
          }
        ]
      },
      {
        "county": "ORANGE",
        "airport_count": 53,
        "major_facilities": [
          {
            "name": "SNA - JOHN WAYNE AIRPORT-ORANGE COUNTY"
          }
        ],
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 47
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 6
          }
        ]
      },
      {
        "county": "SAN DIEGO",
        "airport_count": 49,
        "major_facilities": [
          {
            "name": "SAN - SAN DIEGO INTL-LINDBERGH FLD"
          }
        ],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 30
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 17
          },
          {
            "fac_type": "GLIDERPORT",
            "airport_count": 2
          }
        ]
      },
      {
        "county": "KERN",
        "airport_count": 49,
        "major_facilities": [
          {
            "name": "BFL - MEADOWS FIELD"
          },
          {
            "name": "IYK - INYOKERN"
          }
        ],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 41
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 7
          },
          {
            "fac_type": "ULTRALIGHT",
            "airport_count": 1
          }
        ]
      }
    ]
  },
  {
    "state": "NY",
    "airport_count": 576,
    "top_5_counties": [
      {
        "county": "SUFFOLK",
        "airport_count": 34,
        "major_facilities": [
          {
            "name": "ISP - LONG ISLAND MAC ARTHUR"
          }
        ],
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 18
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 15
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "ERIE",
        "airport_count": 26,
        "major_facilities": [
          {
            "name": "BUF - BUFFALO NIAGARA INTL"
          }
        ],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 18
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 8
          }
        ]
      },
      {
        "county": "NIAGARA",
        "airport_count": 20,
        "major_facilities": [],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 15
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 5
          }
        ]
      },
      {
        "county": "DUTCHESS",
        "airport_count": 20,
        "major_facilities": [],
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 12
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 8
          }
        ]
      },
      {
        "county": "ONONDAGA",
        "airport_count": 18,
        "major_facilities": [
          {
            "name": "SYR - SYRACUSE HANCOCK INTL"
          }
        ],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 13
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 4
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 1
          }
        ]
      }
    ]
  },
  {
    "state": "MN",
    "airport_count": 507,
    "top_5_counties": [
      {
        "county": "ST LOUIS",
        "airport_count": 28,
        "major_facilities": [
          {
            "name": "DLH - DULUTH INTL"
          }
        ],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 13
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 10
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 5
          }
        ]
      },
      {
        "county": "HENNEPIN",
        "airport_count": 23,
        "major_facilities": [
          {
            "name": "MSP - MINNEAPOLIS-ST PAUL INTL/WOLD-CHAMBERLAIN/"
          }
        ],
        "by_facility": [
          {
            "fac_type": "HELIPORT",
            "airport_count": 9
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 8
          },
          {
            "fac_type": "AIRPORT",
            "airport_count": 6
          }
        ]
      },
      {
        "county": "CROW WING",
        "airport_count": 17,
        "major_facilities": [],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 8
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 6
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 1
          },
          {
            "fac_type": "ULTRALIGHT",
            "airport_count": 1
          },
          {
            "fac_type": "STOLPORT",
            "airport_count": 1
          }
        ]
      },
      {
        "county": "DAKOTA",
        "airport_count": 17,
        "major_facilities": [],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 14
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 3
          }
        ]
      },
      {
        "county": "ANOKA",
        "airport_count": 14,
        "major_facilities": [],
        "by_facility": [
          {
            "fac_type": "AIRPORT",
            "airport_count": 9
          },
          {
            "fac_type": "SEAPLANE BASE",
            "airport_count": 3
          },
          {
            "fac_type": "HELIPORT",
            "airport_count": 2
          }
        ]
      }
    ]
  }
]</pre>
      </div>
    </div>
  </div></div>