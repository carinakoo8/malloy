---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/patterns/cohorts.html
---

<div class="document">
      <h1>
        <a id="cohort-analysis" class="header-link anchor" href="#cohort-analysis">
          Cohort Analysis
        </a>
      </h1>
    <p>One of the most powerful way of understanding what is happening using data is to use <em>cohort analisys</em>.
Fundementally, cohort analysis is used to group people into sets and to analyse the success,
attributes or characteristics of that group as compared to the population in general.</p>
<p>To understand this, we're going to use Social Security Administrations birth/name data.</p>
<p>We have a table with <code class="language-malloy">name</code>, <code class="language-malloy">gender</code>, <code class="language-malloy"><span class="token identifier">`year`</span></code>, <code class="language-malloy">state</code> and the <code class="language-malloy"><span class="token identifier">`number`</span></code> of people born with those
characterisitics.</p>
<p>In the simplelist form, a cohort calculation is a <a href="percent_of_total.html">percentage of total calculation</a>.
For example, if we were interested in the name 'Billie' as it relates to location. We could look
could filter on 'Billie' and look a states as it relates to total population.</p>
<p>We can see that in the population of the the people named 'Billie', the cohort of the Billies born in
Texas makes up 18% of the total population of Billies.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> <span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span>
<span class="token operator">|</span> <span class="token keyword">reduce</span> : <span class="token punctuation">[</span>name: <span class="token string">'Billie'</span><span class="token punctuation">]</span>
  total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  main_query <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
    state
    total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">project</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">3</span> <span class="token keyword">desc</span>
  main_query<span class="token punctuation">.</span>state
  main_query<span class="token punctuation">.</span>total_population
  state_as_percent_of_population <span class="token keyword">is</span> main_query<span class="token punctuation">.</span>total_population<span class="token operator">/</span>total_population <span class="token operator">*</span> <span class="token number">100.0</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 1: mismatched input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore 'bigquery-public-data.usa_names.usa_1910_2013'
  | ^</div><p>We could run this same query, but instead look by decade to see when the Billies where born.
Using the query below we can see that 26% of all Billies were born in the 1930s.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> <span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span>
<span class="token operator">|</span> <span class="token keyword">reduce</span> : <span class="token punctuation">[</span>name: <span class="token string">'Billie'</span><span class="token punctuation">]</span>
  total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  main_query <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
    decade <span class="token keyword">is</span> <span class="token function">FLOOR</span><span class="token punctuation">(</span><span class="token identifier">`year`</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span>
    total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">project</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">3</span> <span class="token keyword">desc</span>
  main_query<span class="token punctuation">.</span>decade
  main_query<span class="token punctuation">.</span>total_population
  decade_as_percent_of_population <span class="token keyword">is</span> main_query<span class="token punctuation">.</span>total_population<span class="token operator">/</span>total_population <span class="token operator">*</span> <span class="token number">100.0</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 1: mismatched input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore 'bigquery-public-data.usa_names.usa_1910_2013'
  | ^</div>
      <h2>
        <a id="names-as-cohorts" class="header-link anchor" href="#names-as-cohorts">
          Names as Cohorts
        </a>
      </h2>
    <p>In the above example, the population was <em>People named Billie</em> and we used <em>state</em> or <em>year</em> for our cohort (grouping).
Lets flip it around and look at people born with a particular name as a cohort and the other attributes to limit our popuation.
Let's limit our population to California in 1990 and look at the most cohorts (people with a given name).  We are also going
to measure a little differently.  Instead of looking at a percentage, let's look at births per 100,000 people.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> <span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span>
<span class="token operator">|</span> <span class="token keyword">reduce</span> : <span class="token punctuation">[</span>state: <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token identifier">`year`</span>:<span class="token number">1990</span><span class="token punctuation">]</span>
  total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  main_query <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
    name
    total_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">project</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">3</span> <span class="token keyword">desc</span>
  main_query<span class="token punctuation">.</span>name
  main_query<span class="token punctuation">.</span>total_population
  births_per_100k <span class="token keyword">is</span> <span class="token function">FLOOR</span><span class="token punctuation">(</span>main_query<span class="token punctuation">.</span>total_population<span class="token operator">/</span>total_population <span class="token operator">*</span> <span class="token number">100000.0</span><span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 1: mismatched input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore 'bigquery-public-data.usa_names.usa_1910_2013'
  | ^</div><p>MORE TO COME</p>
<p>First we calculate populations of cohorts (decade, state, gender) and then for
every name in that cohort, we compute the population.</p>
<p>Seconds, we group by arbitrary cohorts and compute the births per 100K for some arbitrary names.</p>
<pre class="language-malloy"><span class="token keyword">explore</span> <span class="token punctuation">(</span><span class="token string">'bigquery-public-data.usa_names.usa_1910_2013'</span>
<span class="token operator">|</span> <span class="token keyword">reduce</span>
    decade <span class="token keyword">is</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token identifier">`year`</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span>
    state
    gender
    cohort_population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    by_name <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span>
      name
      population <span class="token keyword">is</span> <span class="token identifier">`number`</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">reduce</span>
  state
  gender
  total_cohort_population <span class="token keyword">is</span> cohort_population<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  names <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token keyword">reduce</span> :  <span class="token punctuation">[</span>by_name<span class="token punctuation">.</span>name : <span class="token string">'Michael'</span><span class="token operator">|</span><span class="token string">'Lloyd'</span><span class="token operator">|</span><span class="token string">'Olivia'</span><span class="token punctuation">]</span>
    by_name<span class="token punctuation">.</span>name
    population <span class="token keyword">is</span> by_name<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    births_per_100k <span class="token keyword">is</span> <span class="token function">FLOOR</span><span class="token punctuation">(</span>by_name<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>cohort_population<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span></pre><div class="error">Error: Error: Error(s) compiling model:
FILE: internal://internal.malloy
line 1: mismatched input 'explore' expecting {<EOF>, EXPLORE, QUERY, IMPORT, ';'}
  | explore ('bigquery-public-data.usa_names.usa_1910_2013'
  | ^</div></div>