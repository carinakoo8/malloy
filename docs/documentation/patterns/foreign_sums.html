---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/patterns/foreign_sums.html
---

<div class="document">
      <h1>
        <a id="foreign-sums" class="header-link anchor" href="#foreign-sums">
          Foreign Sums
        </a>
      </h1>
    <p>Malloy allows you to compute sums, averages correctly based on your join tree.  This example has flights, joining to aircraft, joining to aircraft_model.
<code class="language-malloy">aircraft_model</code> has the number of seats specified on this model of aircraft.  Code below computes sums and averages at various places in the join tree.</p>
<pre class="language-malloy"><span class="token comment">// join 3 tables, flights, aircraft and aircraft models.</span>
<span class="token comment">// `flights` is individual flights</span>
<span class="token comment">// `aircraft` is the plane that made the flight</span>
<span class="token comment">// `aircraft_models` is data about the kind of aircraft</span>

<span class="token keyword">explore</span>: aircraft_models <span class="token keyword">is</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'malloy-data.faa.aircraft_models'</span><span class="token punctuation">)</span> {
  <span class="token keyword">primary_key</span>: aircraft_model_code
}

<span class="token keyword">explore</span>: aircraft <span class="token keyword">is</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'malloy-data.faa.aircraft'</span><span class="token punctuation">)</span> {
  <span class="token keyword">primary_key</span>: tail_num
  <span class="token keyword">join_one</span>: aircraft_models <span class="token keyword">with</span> aircraft_model_code
}

<span class="token keyword">explore</span>: flights <span class="token keyword">is</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'malloy-data.faa.flights'</span><span class="token punctuation">)</span> {
  <span class="token keyword">join_one</span>: aircraft <span class="token keyword">with</span> tail_num
}

<span class="token keyword">query</span>: flights <span class="token operator">-</span><span class="token operator">></span> {
  <span class="token keyword">where</span>: dep_time <span class="token operator">=</span> <span class="token date">@2003-01</span>
  <span class="token keyword">group_by</span>: carrier
  <span class="token keyword">aggregate</span>: <span class="token punctuation">[</span>
    <span class="token comment">// number of flights</span>
    flight_count <span class="token keyword">is</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// number of planes</span>
    aircraft_count <span class="token keyword">is</span> aircraft<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// number of different aircraft_models</span>
    aircraft_model_count <span class="token keyword">is</span> aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// count each seat once for each flight.</span>
    seats_for_sale <span class="token keyword">is</span> <span class="token function">sum</span><span class="token punctuation">(</span>aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span>
    <span class="token comment">// count the seat once for each plane</span>
    seats_on_all_planes <span class="token keyword">is</span> aircraft<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">)</span>
    <span class="token comment">// average number of seats on each model by model</span>
    average_seats_per_model <span class="token keyword">is</span> aircraft<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">.</span>seats<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
}</pre><div class="result-outer large">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner">
        <table style="border: 1px solid #eaeaea; vertical-align: top; border-bottom: 1px solid #eaeaea; border-collapse: collapse; width: 100%;">
		<thead>
			<tr>
				<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: left;">carrier</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">flight_&#8203;count</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">aircraft_&#8203;count</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">aircraft_&#8203;model_&#8203;count</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">seats_&#8203;for_&#8203;sale</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">seats_&#8203;on_&#8203;all_&#8203;planes</th>
<th style="padding: 8px; color: #505050; border-bottom: 1px solid #eaeaea; text-align: right;">average_&#8203;seats_&#8203;per_&#8203;model</th>
      </tr>
		</thead>
		<tbody>
			<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">WN</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">81,592</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">364</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">23</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">10,984,163</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">51,595</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">110.217</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">AA</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">66,786</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">351</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">69</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">4,374,497</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">54,407</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">21.986</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">DL</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">59,722</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">524</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">23</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">10,666,057</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">105,340</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">190.565</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">UA</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">47,285</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">490</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">12</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">7,637,350</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">114,169</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">263.417</td>
</tr>
<tr><td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; ">NW</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">41,888</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">398</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">22</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">5,731,475</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">65,482</td>
<td style="padding: 8px; vertical-align: top; border-bottom: 1px solid #eaeaea; text-align: right;">211.818</td>
</tr>

		</tbody>
	</table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"carrier"</span><span class="token operator">:</span> <span class="token string">"WN"</span><span class="token punctuation">,</span>
    <span class="token property">"flight_count"</span><span class="token operator">:</span> <span class="token number">81592</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_count"</span><span class="token operator">:</span> <span class="token number">364</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_model_count"</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
    <span class="token property">"seats_for_sale"</span><span class="token operator">:</span> <span class="token number">10984163</span><span class="token punctuation">,</span>
    <span class="token property">"seats_on_all_planes"</span><span class="token operator">:</span> <span class="token number">51595</span><span class="token punctuation">,</span>
    <span class="token property">"average_seats_per_model"</span><span class="token operator">:</span> <span class="token number">110.21739130434783</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"carrier"</span><span class="token operator">:</span> <span class="token string">"AA"</span><span class="token punctuation">,</span>
    <span class="token property">"flight_count"</span><span class="token operator">:</span> <span class="token number">66786</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_count"</span><span class="token operator">:</span> <span class="token number">351</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_model_count"</span><span class="token operator">:</span> <span class="token number">69</span><span class="token punctuation">,</span>
    <span class="token property">"seats_for_sale"</span><span class="token operator">:</span> <span class="token number">4374497</span><span class="token punctuation">,</span>
    <span class="token property">"seats_on_all_planes"</span><span class="token operator">:</span> <span class="token number">54407</span><span class="token punctuation">,</span>
    <span class="token property">"average_seats_per_model"</span><span class="token operator">:</span> <span class="token number">21.985507246376812</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"carrier"</span><span class="token operator">:</span> <span class="token string">"DL"</span><span class="token punctuation">,</span>
    <span class="token property">"flight_count"</span><span class="token operator">:</span> <span class="token number">59722</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_count"</span><span class="token operator">:</span> <span class="token number">524</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_model_count"</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
    <span class="token property">"seats_for_sale"</span><span class="token operator">:</span> <span class="token number">10666057</span><span class="token punctuation">,</span>
    <span class="token property">"seats_on_all_planes"</span><span class="token operator">:</span> <span class="token number">105340</span><span class="token punctuation">,</span>
    <span class="token property">"average_seats_per_model"</span><span class="token operator">:</span> <span class="token number">190.56521739130434</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"carrier"</span><span class="token operator">:</span> <span class="token string">"UA"</span><span class="token punctuation">,</span>
    <span class="token property">"flight_count"</span><span class="token operator">:</span> <span class="token number">47285</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_count"</span><span class="token operator">:</span> <span class="token number">490</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_model_count"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">"seats_for_sale"</span><span class="token operator">:</span> <span class="token number">7637350</span><span class="token punctuation">,</span>
    <span class="token property">"seats_on_all_planes"</span><span class="token operator">:</span> <span class="token number">114169</span><span class="token punctuation">,</span>
    <span class="token property">"average_seats_per_model"</span><span class="token operator">:</span> <span class="token number">263.4166666666667</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"carrier"</span><span class="token operator">:</span> <span class="token string">"NW"</span><span class="token punctuation">,</span>
    <span class="token property">"flight_count"</span><span class="token operator">:</span> <span class="token number">41888</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_count"</span><span class="token operator">:</span> <span class="token number">398</span><span class="token punctuation">,</span>
    <span class="token property">"aircraft_model_count"</span><span class="token operator">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
    <span class="token property">"seats_for_sale"</span><span class="token operator">:</span> <span class="token number">5731475</span><span class="token punctuation">,</span>
    <span class="token property">"seats_on_all_planes"</span><span class="token operator">:</span> <span class="token number">65482</span><span class="token punctuation">,</span>
    <span class="token property">"average_seats_per_model"</span><span class="token operator">:</span> <span class="token number">211.8181818181818</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><span class="token keyword">SELECT</span> 
   flights<span class="token punctuation">.</span>carrier <span class="token keyword">as</span> carrier<span class="token punctuation">,</span>
   <span class="token function">COUNT</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> flight_count<span class="token punctuation">,</span>
   <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> aircraft_0<span class="token punctuation">.</span>tail_num<span class="token punctuation">)</span> <span class="token keyword">as</span> aircraft_count<span class="token punctuation">,</span>
   <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> aircraft_models_0<span class="token punctuation">.</span>aircraft_model_code<span class="token punctuation">)</span> <span class="token keyword">as</span> aircraft_model_count<span class="token punctuation">,</span>
   <span class="token function">SUM</span><span class="token punctuation">(</span>aircraft_models_0<span class="token punctuation">.</span>seats<span class="token punctuation">)</span> <span class="token keyword">as</span> seats_for_sale<span class="token punctuation">,</span>
   CAST<span class="token punctuation">(</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>
      <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span>
        <span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token keyword">COALESCE</span><span class="token punctuation">(</span>aircraft_models_0<span class="token punctuation">.</span>seats<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">NUMERIC</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        <span class="token punctuation">(</span>cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_0<span class="token punctuation">.</span>tail_num <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4294967296</span> <span class="token operator">+</span> cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_0<span class="token punctuation">.</span>tail_num <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.000000001</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">-</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token punctuation">(</span>cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_0<span class="token punctuation">.</span>tail_num <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4294967296</span> <span class="token operator">+</span> cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_0<span class="token punctuation">.</span>tail_num <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.000000001</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> FLOAT64<span class="token punctuation">)</span> <span class="token keyword">as</span> seats_on_all_planes<span class="token punctuation">,</span>
   CAST<span class="token punctuation">(</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>
      <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span>
        <span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token keyword">COALESCE</span><span class="token punctuation">(</span>aircraft_models_0<span class="token punctuation">.</span>seats<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">NUMERIC</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        <span class="token punctuation">(</span>cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_models_0<span class="token punctuation">.</span>aircraft_model_code <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4294967296</span> <span class="token operator">+</span> cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_models_0<span class="token punctuation">.</span>aircraft_model_code <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.000000001</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">-</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token punctuation">(</span>cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_models_0<span class="token punctuation">.</span>aircraft_model_code <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4294967296</span> <span class="token operator">+</span> cast<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span> substr<span class="token punctuation">(</span>to_hex<span class="token punctuation">(</span>md5<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>aircraft_models_0<span class="token punctuation">.</span>aircraft_model_code <span class="token keyword">AS</span> STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> int64<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.000000001</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> FLOAT64<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">NULLIF</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> aircraft_models_0<span class="token punctuation">.</span>aircraft_model_code<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> average_seats_per_model
<span class="token keyword">FROM</span> <span class="token punctuation">`</span>malloy<span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>faa<span class="token punctuation">.</span>flights<span class="token punctuation">`</span> <span class="token keyword">as</span> flights
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">`</span>malloy<span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>faa<span class="token punctuation">.</span>aircraft<span class="token punctuation">`</span> <span class="token keyword">AS</span> aircraft_0 <span class="token keyword">ON</span> flights<span class="token punctuation">.</span>tail_num <span class="token operator">=</span> aircraft_0<span class="token punctuation">.</span>tail_num
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">`</span>malloy<span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>faa<span class="token punctuation">.</span>aircraft_models<span class="token punctuation">`</span> <span class="token keyword">AS</span> aircraft_models_0 <span class="token keyword">ON</span> aircraft_0<span class="token punctuation">.</span>aircraft_model_code <span class="token operator">=</span> aircraft_models_0<span class="token punctuation">.</span>aircraft_model_code
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>flights<span class="token punctuation">.</span>dep_time<span class="token operator">>=</span><span class="token string">'2003-01-01'</span><span class="token punctuation">)</span><span class="token operator">and</span><span class="token punctuation">(</span>flights<span class="token punctuation">.</span>dep_time<span class="token operator">&lt;</span><span class="token string">'2003-02-01'</span><span class="token punctuation">)</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">2</span> <span class="token keyword">desc</span>
</pre>
      </div>
    </div>
  </div></div>