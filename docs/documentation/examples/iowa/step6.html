---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/examples/iowa/step6.html
---

<div class="document">
      <h1>
        <a id="dashboards" class="header-link anchor" href="#dashboards">
          Dashboards
        </a>
      </h1>
    <p>Putting it all together we can write a dashboard</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">vendor_dashboard</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">vendor_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #795E26">distinct</span><span style="color: #000000"> </span><span style="color: #001080">vendor_number</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">total_sale_dollars</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">total_bottles</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_month</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_class</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_vendor_bar_chart</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">top_sellers_by_revenue</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">most_expensive_products</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_vendor_dashboard</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">top</span><span style="color: #000000">: </span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">vendor_name</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_sale_dollars</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">by_month</span><span style="color: #000000">, </span><span style="color: #001080">top_sellers_by_revenue</span><span style="color: #000000">, </span><span style="color: #001080">most_expensive_products</span></span>
<span class="line"><span style="color: #000000">    }</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre>
      <h2>
        <a id="run-dashboard" class="header-link anchor" href="#run-dashboard">
          Run Dashboard
        </a>
      </h2>
    <p>Simply add some filters.  Notice the sub-dashboard for each of the Vendors.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">iowa</span><span style="color: #000000"> { </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">category_class</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> } -&gt; </span><span style="color: #001080">vendor_dashboard</span></span></pre><div class="result-outer large">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner">
        <div><div style="position: relative;"><div class="dimensions" style="display: flex; flex-wrap: wrap;"></div><div class="dashboard-outer" style="display: flex; flex-direction: row; font-size: 11px;"><div style="display: flex; flex-wrap: wrap;"><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">vendor_count</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="font-size: 20px; display: flex; justify-content: center; align-items: center; margin-top: 5px;"><span>275</span></div></div></div><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">total_sale_dollars</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="font-size: 20px; display: flex; justify-content: center; align-items: center; margin-top: 5px;"><span>794,224,481.36</span></div></div></div><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">total_bottles</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="font-size: 20px; display: flex; justify-content: center; align-items: center; margin-top: 5px;"><span>73,968,002</span></div></div></div><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">top_sellers_by_revenue</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="display: flex; justify-content: center; align-items: center; flex-direction: column;"><table style="vertical-align: top; border-collapse: collapse; width: 100%;"><thead><tr><th style="padding: 8px; text-align: left;">vendor_​name</th><th style="padding: 8px; text-align: left;">item_​description</th><th style="padding: 8px; text-align: right;">total_​sale_​dollars</th><th style="padding: 8px; text-align: right;">total_​bottles</th><th style="padding: 8px; text-align: right;">avg_​price_​per_​100ml</th><th style="padding: 8px; text-align: right;">percent_​of_​sales</th></tr></thead><tbody><tr><td style="padding: 8px; vertical-align: top;"><span>FIFTH GENERATION INC</span></td><td style="padding: 8px; vertical-align: top;"><span>Titos Handmade Vodka</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>114,917,664.13</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6,027,811</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1.903</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>14.469</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Luxco-St Louis</span></td><td style="padding: 8px; vertical-align: top;"><span>Hawkeye Vodka</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>45,992,518.19</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6,707,537</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>0.655</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5.791</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Pernod Ricard USA/Austin Nichols</span></td><td style="padding: 8px; vertical-align: top;"><span>Absolut Swedish Vodka 80 Prf</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>30,837,591.61</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,545,367</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.204</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.883</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Bacardi U.S.A., Inc.</span></td><td style="padding: 8px; vertical-align: top;"><span>Grey Goose Vodka</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>26,410,156.5</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,145,209</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.519</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.325</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>DIAGEO AMERICAS</span></td><td style="padding: 8px; vertical-align: top;"><span>Smirnoff 80prf</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>19,877,579.13</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,885,000</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1.668</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.503</span></td></tr></tbody></table></div></div></div></div></div></div></div>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;vendor_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">275</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">794224481.3601199</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">73968002</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_sellers_by_revenue&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;FIFTH GENERATION INC&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Titos Handmade Vodka&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">114917664.13000374</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6027811</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1.9030784205302218</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">14.469166693679062</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Luxco-St Louis&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Hawkeye Vodka&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">45992518.19000298</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6707537</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.6554606565265768</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5.790871380751218</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Pernod Ricard USA/Austin Nichols&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Absolut Swedish Vodka 80 Prf&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30837591.609999333</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1545367</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.2043805281220057</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.8827299250697425</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Bacardi U.S.A., Inc.&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Grey Goose Vodka&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">26410156.499999974</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1145209</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.5186447295186616</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.325276054796527</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;DIAGEO AMERICAS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Smirnoff 80prf&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">19877579.13000032</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1885000</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1.6682797381895054</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.5027658548071576</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> iowa.vendor_number)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_count__0,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars__0,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.bottles_sold),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles__0,</span></span>
<span class="line"><span style="color: #000000">    __lateral_join_bag.vendor_name__1,</span></span>
<span class="line"><span style="color: #000000">    __lateral_join_bag.item_description__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.bottles_sold),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">AVG</span><span style="color: #000000">((iowa.state_bottle_retail/</span><span style="color: #795E26">nullif</span><span style="color: #000000">(iowa.bottle_volume_ml,</span><span style="color: #098658">0</span><span style="color: #000000">)*</span><span style="color: #098658">100</span><span style="color: #000000">))</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> avg_price_per_100ml__1,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> ()*</span><span style="color: #098658">100</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> percent_of_sales__1</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.iowa_liquor_sales.sales_deduped`</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> iowa</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">() -</span><span style="color: #098658">1</span><span style="color: #000000">  group_set </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> UNNEST(GENERATE_ARRAY(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)))</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> UNNEST([STRUCT(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">    iowa.vendor_name</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_name__1,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">    iowa.item_description</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> item_description__1)]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> __lateral_join_bag</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> ((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(WHISK|SCOTCH|BOURBON|RYE)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;WHISKIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;VODKA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;RUM&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;RUMS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;TEQUILA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;TEQUILAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(LIQUE|AMARETTO|TRIPLE SEC)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;LIQUEURS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;BRAND(I|Y)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;BRANDIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;GIN&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;GINS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;SCHNAP&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;SCHNAPPS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">)=</span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">AND</span><span style="color: #000000"> ((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(WHISK|SCOTCH|BOURBON|RYE)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;WHISKIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;VODKA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;RUM&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;RUMS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;TEQUILA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;TEQUILAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(LIQUE|AMARETTO|TRIPLE SEC)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;LIQUEURS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;BRAND(I|Y)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;BRANDIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;GIN&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;GINS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;SCHNAP&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;SCHNAPPS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">)=</span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">AND</span><span style="color: #000000"> ((group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">OR</span><span style="color: #000000"> (group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">AND</span><span style="color: #000000"> (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(WHISK|SCOTCH|BOURBON|RYE)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;WHISKIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;VODKA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;RUM&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;RUMS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;TEQUILA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;TEQUILAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(LIQUE|AMARETTO|TRIPLE SEC)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;LIQUEURS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;BRAND(I|Y)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;BRANDIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;GIN&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;GINS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;SCHNAP&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;SCHNAPPS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">)=</span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000">)))</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">5</span><span style="color: #000000">,</span><span style="color: #098658">6</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> vendor_count__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_count,</span></span>
<span class="line"><span style="color: #000000">  ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> total_sale_dollars__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars,</span></span>
<span class="line"><span style="color: #000000">  ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> total_bottles__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles,</span></span>
<span class="line"><span style="color: #000000">  ARRAY_AGG(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> STRUCT(</span></span>
<span class="line"><span style="color: #000000">    vendor_name__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_name, </span></span>
<span class="line"><span style="color: #000000">    item_description__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> item_description, </span></span>
<span class="line"><span style="color: #000000">    total_sale_dollars__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars, </span></span>
<span class="line"><span style="color: #000000">    total_bottles__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles, </span></span>
<span class="line"><span style="color: #000000">    avg_price_per_100ml__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> avg_price_per_100ml, </span></span>
<span class="line"><span style="color: #000000">    percent_of_sales__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> percent_of_sales</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">END</span><span style="color: #000000"> IGNORE NULLS  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  total_sale_dollars__1 </span><span style="color: #0000FF">desc</span><span style="color: #000000">  </span><span style="color: #0000FF">LIMIT</span><span style="color: #000000"> </span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> top_sellers_by_revenue</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>